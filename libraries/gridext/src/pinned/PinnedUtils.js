import * as DG from 'datagrok-api/dg';
import * as GridUtils from '../utils/GridUtils';
import { PinnedColumn } from "./PinnedColumn";
import { GridCellRendererEx } from "../renderer/GridCellRendererEx";
function getGrid(colGrid) {
    let grid = colGrid.grid;
    if (grid === null) {
        grid = GridUtils.getInstalledGridForColumn(colGrid);
        if (grid instanceof DG.Grid)
            return grid;
    }
    return grid;
}
export function getTotalPinnedRowsHeight(grid) {
    const dart = DG.toDart(grid);
    const nPinnedRowsCounnt = dart.m_arPinnedRows === undefined ? 0 : dart.m_arPinnedRows.length;
    let rowPinned = null;
    let nHeight = 0;
    for (let nR = 0; nR < nPinnedRowsCounnt; ++nR) {
        rowPinned = dart.m_arPinnedRows[nR];
        nHeight += rowPinned.getHeight();
    }
    return nHeight;
}
export function getPinnedColumnLeft(colPinned) {
    var _a;
    const grid = (_a = colPinned.getGridColumn()) === null || _a === void 0 ? void 0 : _a.grid;
    const dart = DG.toDart(grid);
    let colPinnedTmp = null;
    let nW = 0;
    const nPinnedColCount = dart.m_arPinnedCols === undefined ? 0 : dart.m_arPinnedCols.length;
    for (let n = 0; n < nPinnedColCount; ++n) {
        colPinnedTmp = dart.m_arPinnedCols[n];
        if (colPinned === colPinnedTmp) {
            break;
        }
        nW += colPinnedTmp.getWidth();
    }
    return nW;
}
export function getTotalPinnedColsWidth(grid) {
    const dart = DG.toDart(grid);
    const nPinnedColsCounnt = dart.m_arPinnedCols === undefined ? 0 : dart.m_arPinnedCols.length;
    let colPinned = null;
    let nWidth = 0;
    for (let nR = 0; nR < nPinnedColsCounnt; ++nR) {
        colPinned = dart.m_arPinnedCols[nR];
        nWidth += colPinned.getWidth();
    }
    return nWidth;
}
export function findPinnedColumnByRoot(eCanvas, grid) {
    const dart = DG.toDart(grid);
    let colPinned = null;
    const nPinnedColCount = dart.m_arPinnedCols === undefined ? 0 : dart.m_arPinnedCols.length;
    for (let n = 0; n < nPinnedColCount; ++n) {
        colPinned = dart.m_arPinnedCols[n];
        if (colPinned.getRoot() === eCanvas) {
            return colPinned;
        }
    }
    return null;
}
export function getPinnedColumnCount(grid) {
    const dart = DG.toDart(grid);
    const nPinnedColCount = dart.m_arPinnedCols === undefined ? 0 : dart.m_arPinnedCols.length;
    return nPinnedColCount;
}
export function getPinnedColumn(nIdx, grid) {
    if (nIdx < 0) {
        throw new Error("Pinned column index cannot be negative: " + nIdx);
    }
    const dart = DG.toDart(grid);
    const nPinnedColCount = dart.m_arPinnedCols === undefined ? 0 : dart.m_arPinnedCols.length;
    if (nIdx >= nPinnedColCount) {
        throw new Error("Pinned column index cis out of bounds [0,: " + (nPinnedColCount - 1) + "]");
    }
    return dart.m_arPinnedCols[nIdx];
}
export function addPinnedColumn(colGrid) {
    const colPinned = new PinnedColumn(colGrid);
    return colPinned;
}
export function closeAllPinnedColumns(grid) {
    const dart = DG.toDart(grid);
    let colPinned = null;
    const nPinnedColCount = dart.m_arPinnedCols === undefined ? 0 : dart.m_arPinnedCols.length;
    for (let n = 1; n < nPinnedColCount; ++n) {
        colPinned = dart.m_arPinnedCols[1]; //0 is not a bug
        colPinned.close();
    }
}
export function installPinnedColumns(grid) {
    closeAllPinnedColumns(grid);
    let colGrid = null;
    let settings = null;
    const lstCols = grid.columns;
    const arColsToPin = new Array();
    for (let nCol = 0; nCol < lstCols.length; ++nCol) {
        colGrid = lstCols.byIndex(nCol);
        if (colGrid === null || GridUtils.isRowHeader(colGrid))
            continue;
        settings = colGrid.settings;
        if (settings !== null && settings !== undefined && settings.isPinned) {
            arColsToPin.push(colGrid);
        }
    }
    arColsToPin.sort((colOne, colTwo) => {
        if (colOne.settings.idxPinned === colTwo.settings.idxPinned) {
            return 0; //throw new Error("Pinned indices cannot be equal for different columns");
        }
        return colOne.settings.idxPinned < colTwo.settings.idxPinned ? -1 : 1;
    });
    for (let n = 0; n < arColsToPin.length; ++n) {
        colGrid = arColsToPin[n];
        if (isPinnableColumn(colGrid)) {
            new PinnedColumn(colGrid);
        }
    }
}
export function isPinnedColumn(colGrid) {
    const grid = getGrid(colGrid);
    const dart = DG.toDart(grid);
    if (dart.m_arPinnedCols === undefined)
        return false;
    let colPinned = null;
    const nPinnedColCount = dart.m_arPinnedCols.length;
    for (let nColPin = 0; nColPin < nPinnedColCount; ++nColPin) {
        colPinned = dart.m_arPinnedCols[nColPin];
        if (DG.toDart(colPinned.m_colGrid) === DG.toDart(colGrid))
            return true;
    }
    return false;
}
export function isPinnableColumn(colGrid) {
    const b = isPinnedColumn(colGrid);
    if (b) {
        return false;
    }
    let grid = getGrid(colGrid);
    if (!(grid instanceof DG.Grid)) {
        grid = GridUtils.getInstalledGridForColumn(colGrid);
        if (!(grid instanceof DG.Grid)) {
            return false;
        }
    }
    //temporary disable to allow de-serialization from layout if(grid.canvas.offsetWidth <= colGrid.width) {
    //return false;
    //}
    if (colGrid.cellType === "html") {
        const renderer = GridUtils.getGridColumnRenderer(colGrid);
        if (!(renderer instanceof GridCellRendererEx)) {
            return false;
        }
    }
    return true;
}
export function handleContextMenu(args, fnMenuCallback) {
    const grid = args.args.context;
    if (!(grid instanceof DG.Grid)) {
        return;
    }
    const e = args.causedBy;
    //Check if we are on a pinned column
    const elem = document.elementFromPoint(e.clientX, e.clientY);
    if (elem instanceof HTMLCanvasElement) {
        const colPinned = findPinnedColumnByRoot(elem, grid);
        if (colPinned !== null) {
            let menu = args.args.menu;
            fnMenuCallback(menu, colPinned, grid);
            e.preventDefault();
            e.stopPropagation();
            return;
        }
    }
    //Regular Columns
    const cell = grid.hitTest(e.offsetX, e.offsetY);
    if (cell === undefined || cell === null || cell.cellType === null) //bug in DG , top left cell
        return;
    const colGrid = cell.gridColumn;
    if (!isPinnableColumn(colGrid)) {
        return;
    }
    if ((cell.isTableCell || cell.isColHeader) && (elem === grid.canvas || elem === grid.overlay)) {
        const menu = args.args.menu;
        fnMenuCallback(menu, colGrid, grid);
        e.preventDefault();
        e.stopPropagation();
        return;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUGlubmVkVXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJQaW5uZWRVdGlscy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEtBQUssRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3RDLE9BQU8sS0FBSyxTQUFTLE1BQU0sb0JBQW9CLENBQUM7QUFFaEQsT0FBTyxFQUFDLFlBQVksRUFBQyxNQUFNLGdCQUFnQixDQUFDO0FBQzVDLE9BQU8sRUFBQyxrQkFBa0IsRUFBQyxNQUFNLGdDQUFnQyxDQUFDO0FBRWxFLFNBQVMsT0FBTyxDQUFDLE9BQXVCO0lBQ3RDLElBQUksSUFBSSxHQUFvQixPQUFPLENBQUMsSUFBSSxDQUFDO0lBQ3pDLElBQUksSUFBSSxLQUFLLElBQUksRUFBRTtRQUNqQixJQUFJLEdBQUcsU0FBUyxDQUFDLHlCQUF5QixDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ3BELElBQUcsSUFBSSxZQUFZLEVBQUUsQ0FBQyxJQUFJO1lBQ3hCLE9BQU8sSUFBSSxDQUFDO0tBQ2Y7SUFFRCxPQUFPLElBQUksQ0FBQztBQUNkLENBQUM7QUFHRCxNQUFNLFVBQVUsd0JBQXdCLENBQUMsSUFBYztJQUVyRCxNQUFNLElBQUksR0FBRyxFQUFFLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBRTdCLE1BQU0saUJBQWlCLEdBQUcsSUFBSSxDQUFDLGNBQWMsS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUM7SUFDN0YsSUFBSSxTQUFTLEdBQUcsSUFBSSxDQUFDO0lBQ3JCLElBQUksT0FBTyxHQUFHLENBQUMsQ0FBQztJQUNoQixLQUFJLElBQUksRUFBRSxHQUFDLENBQUMsRUFBRSxFQUFFLEdBQUMsaUJBQWlCLEVBQUUsRUFBRSxFQUFFLEVBQUU7UUFDeEMsU0FBUyxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsRUFBRSxDQUFDLENBQUM7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YXMgREcgZnJvbSAnZGF0YWdyb2stYXBpL2RnJztcclxuaW1wb3J0ICogYXMgR3JpZFV0aWxzIGZyb20gJy4uL3V0aWxzL0dyaWRVdGlscyc7XHJcbmltcG9ydCAqIGFzIFBpbm5lZFV0aWxzIGZyb20gXCIuL1Bpbm5lZFV0aWxzXCI7XHJcbmltcG9ydCB7UGlubmVkQ29sdW1ufSBmcm9tIFwiLi9QaW5uZWRDb2x1bW5cIjtcclxuaW1wb3J0IHtHcmlkQ2VsbFJlbmRlcmVyRXh9IGZyb20gXCIuLi9yZW5kZXJlci9HcmlkQ2VsbFJlbmRlcmVyRXhcIjtcclxuXHJcbmZ1bmN0aW9uIGdldEdyaWQoY29sR3JpZCA6IERHLkdyaWRDb2x1bW4pIDogREcuR3JpZCB8IG51bGwge1xyXG4gIGxldCBncmlkIDogREcuR3JpZCB8IG51bGwgPSBjb2xHcmlkLmdyaWQ7XHJcbiAgaWYoIGdyaWQgPT09IG51bGwpIHtcclxuICAgIGdyaWQgPSBHcmlkVXRpbHMuZ2V0SW5zdGFsbGVkR3JpZEZvckNvbHVtbihjb2xHcmlkKTtcclxuICAgIGlmKGdyaWQgaW5zdGFuY2VvZiBERy5HcmlkKVxyXG4gICAgICByZXR1cm4gZ3JpZDtcclxuICB9XHJcblxyXG4gIHJldHVybiBncmlkO1xyXG59XHJcblxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGdldFRvdGFsUGlubmVkUm93c0hlaWdodChncmlkIDogREcuR3JpZCkgOiBudW1iZXIge1xyXG5cclxuICBjb25zdCBkYXJ0ID0gREcudG9EYXJ0KGdyaWQpO1xyXG5cclxuICBjb25zdCBuUGlubmVkUm93c0NvdW5udCA9IGRhcnQubV9hclBpbm5lZFJvd3MgPT09IHVuZGVmaW5lZCA/IDAgOiBkYXJ0Lm1fYXJQaW5uZWRSb3dzLmxlbmd0aDtcclxuICBsZXQgcm93UGlubmVkID0gbnVsbDtcclxuICBsZXQgbkhlaWdodCA9IDA7XHJcbiAgZm9yKGxldCBuUj0wOyBuUjxuUGlubmVkUm93c0NvdW5udDsgKytuUikge1xyXG4gICAgcm93UGlubmVkID0gZGFydC5tX2FyUGlubmVkUm93c1tuUl07XHJcbiAgICBuSGVpZ2h0ICs9IHJvd1Bpbm5lZC5nZXRIZWlnaHQoKTtcclxuICB9XHJcblxyXG4gIHJldHVybiBuSGVpZ2h0O1xyXG59XHJcblxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGdldFBpbm5lZENvbHVtbkxlZnQoY29sUGlubmVkIDogUGlubmVkQ29sdW1uKSA6IG51bWJlciB7XHJcbiAgY29uc3QgZ3JpZCA9IGNvbFBpbm5lZC5nZXRHcmlkQ29sdW1uKCk/LmdyaWQ7XHJcbiAgY29uc3QgZGFydCA9IERHLnRvRGFydChncmlkKTtcclxuICBsZXQgY29sUGlubmVkVG1wID0gbnVsbDtcclxuXHJcbiAgbGV0IG5XID0gMDtcclxuICBjb25zdCBuUGlubmVkQ29sQ291bnQgPWRhcnQubV9hclBpbm5lZENvbHMgPT09IHVuZGVmaW5lZCA/IDAgOiBkYXJ0Lm1fYXJQaW5uZWRDb2xzLmxlbmd0aDtcclxuICBmb3IobGV0IG49MDsgbjxuUGlubmVkQ29sQ291bnQ7ICsrbikge1xyXG4gICAgY29sUGlubmVkVG1wID0gZGFydC5tX2FyUGlubmVkQ29sc1tuXTtcclxuICAgIGlmKGNvbFBpbm5lZCA9PT0gY29sUGlubmVkVG1wKSB7XHJcbiAgICAgIGJyZWFrO1xyXG4gICAgfVxyXG4gICAgblcgKz0gY29sUGlubmVkVG1wLmdldFdpZHRoKCk7XHJcbiAgfVxyXG5cclxuICByZXR1cm4gblc7XHJcbn1cclxuXHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0VG90YWxQaW5uZWRDb2xzV2lkdGgoZ3JpZCA6IERHLkdyaWQpIDogbnVtYmVyIHtcclxuICBjb25zdCBkYXJ0ID0gREcudG9EYXJ0KGdyaWQpO1xyXG4gIGNvbnN0IG5QaW5uZWRDb2xzQ291bm50ID0gZGFydC5tX2FyUGlubmVkQ29scyA9PT0gdW5kZWZpbmVkID8gMCA6IGRhcnQubV9hclBpbm5lZENvbHMubGVuZ3RoO1xyXG4gIGxldCBjb2xQaW5uZWQgPSBudWxsO1xyXG4gIGxldCBuV2lkdGggPSAwO1xyXG4gIGZvcihsZXQgblI9MDsgblI8blBpbm5lZENvbHNDb3VubnQ7ICsrblIpIHtcclxuICAgIGNvbFBpbm5lZCA9IGRhcnQubV9hclBpbm5lZENvbHNbblJdO1xyXG4gICAgbldpZHRoICs9IGNvbFBpbm5lZC5nZXRXaWR0aCgpO1xyXG4gIH1cclxuXHJcbiAgcmV0dXJuIG5XaWR0aDtcclxufVxyXG5cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBmaW5kUGlubmVkQ29sdW1uQnlSb290KGVDYW52YXMgOiBIVE1MQ2FudmFzRWxlbWVudCwgZ3JpZCA6IERHLkdyaWQpIDogUGlubmVkQ29sdW1uIHwgbnVsbCB7XHJcbiAgY29uc3QgZGFydCA9IERHLnRvRGFydChncmlkKTtcclxuICBsZXQgY29sUGlubmVkID0gbnVsbDtcclxuICBjb25zdCBuUGlubmVkQ29sQ291bnQgPWRhcnQubV9hclBpbm5lZENvbHMgPT09IHVuZGVmaW5lZCA/IDAgOiBkYXJ0Lm1fYXJQaW5uZWRDb2xzLmxlbmd0aDtcclxuICBmb3IobGV0IG49MDsgbjxuUGlubmVkQ29sQ291bnQ7ICsrbikge1xyXG4gICAgY29sUGlubmVkID0gZGFydC5tX2FyUGlubmVkQ29sc1tuXTtcclxuICAgIGlmKGNvbFBpbm5lZC5nZXRSb290KCkgPT09IGVDYW52YXMpIHtcclxuICAgICAgcmV0dXJuIGNvbFBpbm5lZDtcclxuICAgIH1cclxuICB9XHJcbiAgcmV0dXJuIG51bGw7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRQaW5uZWRDb2x1bW5Db3VudChncmlkIDogREcuR3JpZCkgOiBudW1iZXIge1xyXG4gIGNvbnN0IGRhcnQgPSBERy50b0RhcnQoZ3JpZCk7XHJcbiAgY29uc3QgblBpbm5lZENvbENvdW50ID1kYXJ0Lm1fYXJQaW5uZWRDb2xzID09PSB1bmRlZmluZWQgPyAwIDogZGFydC5tX2FyUGlubmVkQ29scy5sZW5ndGg7XHJcbiAgcmV0dXJuIG5QaW5uZWRDb2xDb3VudDtcclxufVxyXG5cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRQaW5uZWRDb2x1bW4obklkeCA6IG51bWJlciwgZ3JpZCA6IERHLkdyaWQpIDogUGlubmVkQ29sdW1uIHtcclxuICBpZihuSWR4IDwgMCkge1xyXG4gICAgdGhyb3cgbmV3IEVycm9yKFwiUGlubmVkIGNvbHVtbiBpbmRleCBjYW5ub3QgYmUgbmVnYXRpdmU6IFwiICsgbklkeCk7XHJcbiAgfVxyXG5cclxuICBjb25zdCBkYXJ0ID0gREcudG9EYXJ0KGdyaWQpO1xyXG4gIGNvbnN0IG5QaW5uZWRDb2xDb3VudCA9ZGFydC5tX2FyUGlubmVkQ29scyA9PT0gdW5kZWZpbmVkID8gMCA6IGRhcnQubV9hclBpbm5lZENvbHMubGVuZ3RoO1xyXG4gIGlmKG5JZHggPj0gblBpbm5lZENvbENvdW50KSB7XHJcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJQaW5uZWQgY29sdW1uIGluZGV4IGNpcyBvdXQgb2YgYm91bmRzIFswLDogXCIgKyAoblBpbm5lZENvbENvdW50IC0xKSArIFwiXVwiKTtcclxuICB9XHJcblxyXG4gIHJldHVybiBkYXJ0Lm1fYXJQaW5uZWRDb2xzW25JZHhdO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gYWRkUGlubmVkQ29sdW1uKGNvbEdyaWQgOiBERy5HcmlkQ29sdW1uKSA6IFBpbm5lZENvbHVtbiB7XHJcbiAgY29uc3QgY29sUGlubmVkID0gbmV3IFBpbm5lZENvbHVtbihjb2xHcmlkKTtcclxuICByZXR1cm4gY29sUGlubmVkO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gY2xvc2VBbGxQaW5uZWRDb2x1bW5zKGdyaWQgOiBERy5HcmlkKSA6IHZvaWQge1xyXG4gIGNvbnN0IGRhcnQgPSBERy50b0RhcnQoZ3JpZCk7XHJcbiAgbGV0IGNvbFBpbm5lZCA9IG51bGw7XHJcbiAgY29uc3QgblBpbm5lZENvbENvdW50ID1kYXJ0Lm1fYXJQaW5uZWRDb2xzID09PSB1bmRlZmluZWQgPyAwIDogZGFydC5tX2FyUGlubmVkQ29scy5sZW5ndGg7XHJcbiAgZm9yKGxldCBuPTE7IG48blBpbm5lZENvbENvdW50OyArK24pIHtcclxuICAgIGNvbFBpbm5lZCA9IGRhcnQubV9hclBpbm5lZENvbHNbMV07IC8vMCBpcyBub3QgYSBidWdcclxuICAgIGNvbFBpbm5lZC5jbG9zZSgpO1xyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGluc3RhbGxQaW5uZWRDb2x1bW5zKGdyaWQgOiBERy5HcmlkKSA6IHZvaWQge1xyXG4gIGNsb3NlQWxsUGlubmVkQ29sdW1ucyhncmlkKTtcclxuXHJcbiAgbGV0IGNvbEdyaWQgPSBudWxsO1xyXG4gIGxldCBzZXR0aW5ncyA6IGFueSA9IG51bGw7XHJcbiAgY29uc3QgbHN0Q29scyA9IGdyaWQuY29sdW1ucztcclxuICBjb25zdCBhckNvbHNUb1BpbiA9IG5ldyBBcnJheTxERy5HcmlkQ29sdW1uPigpO1xyXG5cclxuICBmb3IobGV0IG5Db2w9MDtuQ29sPGxzdENvbHMubGVuZ3RoOyArK25Db2wpIHtcclxuICAgIGNvbEdyaWQgPSBsc3RDb2xzLmJ5SW5kZXgobkNvbCk7XHJcbiAgICBpZihjb2xHcmlkID09PSBudWxsIHx8IEdyaWRVdGlscy5pc1Jvd0hlYWRlcihjb2xHcmlkKSlcclxuICAgICAgY29udGludWU7XHJcblxyXG4gICAgc2V0dGluZ3MgPSBjb2xHcmlkLnNldHRpbmdzO1xyXG4gICAgaWYoc2V0dGluZ3MgIT09IG51bGwgJiYgc2V0dGluZ3MgIT09IHVuZGVmaW5lZCAmJiBzZXR0aW5ncy5pc1Bpbm5lZCkge1xyXG4gICAgICBhckNvbHNUb1Bpbi5wdXNoKGNvbEdyaWQpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgYXJDb2xzVG9QaW4uc29ydCgoY29sT25lLCBjb2xUd28pID0+IHtcclxuICAgIGlmKGNvbE9uZS5zZXR0aW5ncy5pZHhQaW5uZWQgPT09IGNvbFR3by5zZXR0aW5ncy5pZHhQaW5uZWQpIHtcclxuICAgICAgcmV0dXJuIDA7Ly90aHJvdyBuZXcgRXJyb3IoXCJQaW5uZWQgaW5kaWNlcyBjYW5ub3QgYmUgZXF1YWwgZm9yIGRpZmZlcmVudCBjb2x1bW5zXCIpO1xyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiBjb2xPbmUuc2V0dGluZ3MuaWR4UGlubmVkIDwgY29sVHdvLnNldHRpbmdzLmlkeFBpbm5lZCA/IC0xIDogMTtcclxuICB9KTtcclxuXHJcbiAgZm9yKGxldCBuPTA7bjxhckNvbHNUb1Bpbi5sZW5ndGg7ICsrbikge1xyXG4gICAgY29sR3JpZCA9IGFyQ29sc1RvUGluW25dO1xyXG4gICAgaWYoaXNQaW5uYWJsZUNvbHVtbihjb2xHcmlkKSkge1xyXG4gICAgICBuZXcgUGlubmVkQ29sdW1uKGNvbEdyaWQpO1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG5cclxuXHJcblxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGlzUGlubmVkQ29sdW1uKGNvbEdyaWQgOiBERy5HcmlkQ29sdW1uKSA6IGJvb2xlYW4ge1xyXG4gIGNvbnN0IGdyaWQgPSBnZXRHcmlkKGNvbEdyaWQpO1xyXG4gIGNvbnN0IGRhcnQgPSBERy50b0RhcnQoZ3JpZCk7XHJcblxyXG4gIGlmKGRhcnQubV9hclBpbm5lZENvbHMgPT09IHVuZGVmaW5lZClcclxuICAgIHJldHVybiBmYWxzZTtcclxuXHJcbiAgbGV0IGNvbFBpbm5lZCA9IG51bGw7XHJcbiAgY29uc3QgblBpbm5lZENvbENvdW50ID0gZGFydC5tX2FyUGlubmVkQ29scy5sZW5ndGg7XHJcbiAgZm9yKGxldCBuQ29sUGluPTA7IG5Db2xQaW48blBpbm5lZENvbENvdW50OyArK25Db2xQaW4pIHtcclxuICAgIGNvbFBpbm5lZCA9IGRhcnQubV9hclBpbm5lZENvbHNbbkNvbFBpbl07XHJcbiAgICBpZihERy50b0RhcnQoY29sUGlubmVkLm1fY29sR3JpZCkgPT09IERHLnRvRGFydChjb2xHcmlkKSlcclxuICAgICAgcmV0dXJuIHRydWU7XHJcbiAgfVxyXG5cclxuICByZXR1cm4gZmFsc2U7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBpc1Bpbm5hYmxlQ29sdW1uKGNvbEdyaWQgOiBERy5HcmlkQ29sdW1uKSA6IGJvb2xlYW4ge1xyXG4gIGNvbnN0IGIgPSBpc1Bpbm5lZENvbHVtbihjb2xHcmlkKTtcclxuICBpZihiKSB7XHJcbiAgICByZXR1cm4gZmFsc2U7XHJcbiAgfVxyXG5cclxuXHJcbiAgbGV0IGdyaWQgOiBERy5HcmlkIHwgbnVsbCA9IGdldEdyaWQoY29sR3JpZCk7XHJcbiAgaWYoIShncmlkIGluc3RhbmNlb2YgREcuR3JpZCkpIHtcclxuICAgIGdyaWQgPSBHcmlkVXRpbHMuZ2V0SW5zdGFsbGVkR3JpZEZvckNvbHVtbihjb2xHcmlkKTtcclxuXHJcbiAgICBpZighKGdyaWQgaW5zdGFuY2VvZiBERy5HcmlkKSkge1xyXG4gICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvL3RlbXBvcmFyeSBkaXNhYmxlIHRvIGFsbG93IGRlLXNlcmlhbGl6YXRpb24gZnJvbSBsYXlvdXQgaWYoZ3JpZC5jYW52YXMub2Zmc2V0V2lkdGggPD0gY29sR3JpZC53aWR0aCkge1xyXG4gICAgLy9yZXR1cm4gZmFsc2U7XHJcbiAgLy99XHJcblxyXG4gIGlmKGNvbEdyaWQuY2VsbFR5cGUgPT09IFwiaHRtbFwiKSB7XHJcbiAgICBjb25zdCByZW5kZXJlciA9IEdyaWRVdGlscy5nZXRHcmlkQ29sdW1uUmVuZGVyZXIoY29sR3JpZCk7XHJcbiAgICBpZighKHJlbmRlcmVyIGluc3RhbmNlb2YgR3JpZENlbGxSZW5kZXJlckV4KSkge1xyXG4gICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICByZXR1cm4gdHJ1ZTtcclxufVxyXG5cclxuXHJcblxyXG5cclxuXHJcblxyXG5leHBvcnQgZnVuY3Rpb24gaGFuZGxlQ29udGV4dE1lbnUoYXJncyA6IGFueSwgZm5NZW51Q2FsbGJhY2sgOiBGdW5jdGlvbikgOiB2b2lkIHtcclxuICBjb25zdCBncmlkID0gYXJncy5hcmdzLmNvbnRleHQ7XHJcbiAgaWYgKCEoZ3JpZCBpbnN0YW5jZW9mIERHLkdyaWQpKSB7XHJcbiAgICByZXR1cm47XHJcbiAgfVxyXG4gIGNvbnN0IGUgPSBhcmdzLmNhdXNlZEJ5O1xyXG4gIC8vQ2hlY2sgaWYgd2UgYXJlIG9uIGEgcGlubmVkIGNvbHVtblxyXG4gIGNvbnN0IGVsZW0gPSBkb2N1bWVudC5lbGVtZW50RnJvbVBvaW50KGUuY2xpZW50WCwgZS5jbGllbnRZKTtcclxuICBpZiAoZWxlbSBpbnN0YW5jZW9mIEhUTUxDYW52YXNFbGVtZW50KSB7XHJcbiAgICBjb25zdCBjb2xQaW5uZWQgPSBmaW5kUGlubmVkQ29sdW1uQnlSb290KGVsZW0sIGdyaWQpO1xyXG4gICAgaWYgKGNvbFBpbm5lZCAhPT0gbnVsbCkge1xyXG4gICAgICBsZXQgbWVudSA9IGFyZ3MuYXJncy5tZW51O1xyXG4gICAgICBmbk1lbnVDYWxsYmFjayhtZW51LCBjb2xQaW5uZWQsIGdyaWQpO1xyXG4gICAgICBlLnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICB9XHJcbiAgLy9SZWd1bGFyIENvbHVtbnNcclxuICBjb25zdCBjZWxsID0gZ3JpZC5oaXRUZXN0KGUub2Zmc2V0WCwgZS5vZmZzZXRZKTtcclxuICBpZiAoY2VsbCA9PT0gdW5kZWZpbmVkIHx8IGNlbGwgPT09IG51bGwgfHwgY2VsbC5jZWxsVHlwZSA9PT0gbnVsbCkgLy9idWcgaW4gREcgLCB0b3AgbGVmdCBjZWxsXHJcbiAgICByZXR1cm47XHJcblxyXG4gIGNvbnN0IGNvbEdyaWQgPSBjZWxsLmdyaWRDb2x1bW47XHJcbiAgaWYoIWlzUGlubmFibGVDb2x1bW4oY29sR3JpZCkpIHtcclxuICAgIHJldHVybjtcclxuICB9XHJcblxyXG4gIGlmICgoY2VsbC5pc1RhYmxlQ2VsbCB8fCBjZWxsLmlzQ29sSGVhZGVyKSAgJiYgKGVsZW0gPT09IGdyaWQuY2FudmFzIHx8IGVsZW0gPT09IGdyaWQub3ZlcmxheSkpIHtcclxuICAgIGNvbnN0IG1lbnUgPSBhcmdzLmFyZ3MubWVudTtcclxuICAgIGZuTWVudUNhbGxiYWNrKG1lbnUsIGNvbEdyaWQsIGdyaWQpO1xyXG4gICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcclxuICAgIHJldHVybjtcclxuICB9XHJcbn1cclxuIl19