var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
import * as grok from 'datagrok-api/grok';
import * as DG from 'datagrok-api/dg';
import * as GridUtils from '../utils/GridUtils';
import * as PinnedUtils from "./PinnedUtils";
import { PinnedColumn } from "./PinnedColumn";
import { GridCellRendererEx } from "../renderer/GridCellRendererEx";
function getGrid(colGrid) {
    let grid = colGrid.grid;
    if (grid === null) {
        grid = GridUtils.getInstalledGridForColumn(colGrid);
        if (grid instanceof DG.Grid)
            return grid;
    }
    return grid;
}
export function getTotalPinnedRowsHeight(grid) {
    const dart = DG.toDart(grid);
    const nPinnedRowsCounnt = dart.m_arPinnedRows === undefined ? 0 : dart.m_arPinnedRows.length;
    let rowPinned = null;
    let nHeight = 0;
    for (let nR = 0; nR < nPinnedRowsCounnt; ++nR) {
        rowPinned = dart.m_arPinnedRows[nR];
        nHeight += rowPinned.getHeight();
    }
    return nHeight;
}
export function getPinnedColumnLeft(colPinned) {
    var _a;
    const grid = (_a = colPinned.getGridColumn()) === null || _a === void 0 ? void 0 : _a.grid;
    const dart = DG.toDart(grid);
    let colPinnedTmp = null;
    let nW = 0;
    const nPinnedColCount = dart.m_arPinnedCols === undefined ? 0 : dart.m_arPinnedCols.length;
    for (let n = 0; n < nPinnedColCount; ++n) {
        colPinnedTmp = dart.m_arPinnedCols[n];
        if (colPinned === colPinnedTmp) {
            break;
        }
        nW += colPinnedTmp.getWidth();
    }
    return nW;
}
export function setPinnedColumnWidth(colPinned, nW) {
    var _a;
    const grid = (_a = colPinned.getGridColumn()) === null || _a === void 0 ? void 0 : _a.grid;
    if (grid === null || grid === undefined)
        return;
    const dart = DG.toDart(grid);
    let colPinnedTmp = null;
    const nPinnedColCount = dart.m_arPinnedCols === undefined ? 0 : dart.m_arPinnedCols.length;
    let n = 0;
    for (; n < nPinnedColCount; ++n) {
        colPinnedTmp = dart.m_arPinnedCols[n];
        if (colPinned === colPinnedTmp) {
            break;
        }
    }
    if (n === nPinnedColCount)
        return;
    let eCanvas = colPinnedTmp.getRoot();
    if (eCanvas === null)
        return;
    //This Pinned Column
    const nWCol = colPinned.getWidth();
    let nXDiff = nW - nWCol;
    if (grid.canvas.offsetWidth - nXDiff < 20) {
        nXDiff = grid.canvas.offsetWidth - 20;
        nW = nWCol + nXDiff;
    }
    eCanvas.width = nW * window.devicePixelRatio;
    eCanvas.style.width = nW.toString() + "px";
    //console.log('nWWWCol: ' + nW + " nXDiff= " + nXDiff + " new W= " + nXDiff);
    const g = eCanvas.getContext('2d');
    colPinned.paint(g, grid);
    ++n;
    for (; n < nPinnedColCount; ++n) {
        colPinnedTmp = dart.m_arPinnedCols[n];
        eCanvas = colPinnedTmp.getRoot();
        if (eCanvas === null)
            continue;
        eCanvas.style.left = (eCanvas.offsetLeft + nXDiff).toString() + "px";
    }
    //Grid
    grid.canvas.style.left = (grid.canvas.offsetLeft + nXDiff).toString() + "px";
    grid.overlay.style.left = (grid.overlay.offsetLeft + nXDiff).toString() + "px";
    grid.canvas.style.width = (grid.canvas.offsetWidth - nXDiff).toString() + "px";
    grid.overlay.style.width = (grid.overlay.offsetWidth - nXDiff).toString() + "px";
    grid.invalidate();
}
export function getTotalPinnedColsWidth(grid) {
    const dart = DG.toDart(grid);
    const nPinnedColsCounnt = dart.m_arPinnedCols === undefined ? 0 : dart.m_arPinnedCols.length;
    let colPinned = null;
    let nWidth = 0;
    for (let nR = 0; nR < nPinnedColsCounnt; ++nR) {
        colPinned = dart.m_arPinnedCols[nR];
        nWidth += colPinned.getWidth();
    }
    return nWidth;
}
export function findPinnedColumnByRoot(eCanvas, grid) {
    const dart = DG.toDart(grid);
    let colPinned = null;
    const nPinnedColCount = dart.m_arPinnedCols === undefined ? 0 : dart.m_arPinnedCols.length;
    for (let n = 0; n < nPinnedColCount; ++n) {
        colPinned = dart.m_arPinnedCols[n];
        if (colPinned.getRoot() === eCanvas) {
            return colPinned;
        }
    }
    return null;
}
export function getPinnedColumnCount(grid) {
    const dart = DG.toDart(grid);
    const nPinnedColCount = dart.m_arPinnedCols === undefined ? 0 : dart.m_arPinnedCols.length;
    return nPinnedColCount;
}
export function getPinnedColumn(nIdx, grid) {
    if (nIdx < 0) {
        throw new Error("Pinned column index cannot be negative: " + nIdx);
    }
    const dart = DG.toDart(grid);
    const nPinnedColCount = dart.m_arPinnedCols === undefined ? 0 : dart.m_arPinnedCols.length;
    if (nIdx >= nPinnedColCount) {
        throw new Error("Pinned column index cis out of bounds [0,: " + (nPinnedColCount - 1) + "]");
    }
    return dart.m_arPinnedCols[nIdx];
}
export function addPinnedColumn(colGrid) {
    const colPinned = new PinnedColumn(colGrid);
    return colPinned;
}
export function closeAllPinnedColumns(grid) {
    const dart = DG.toDart(grid);
    let colPinned = null;
    const nPinnedColCount = dart.m_arPinnedCols === undefined ? 0 : dart.m_arPinnedCols.length;
    for (let n = 1; n < nPinnedColCount; ++n) {
        colPinned = dart.m_arPinnedCols[1]; //0 is not a bug
        colPinned.close();
    }
}
export function installPinnedColumns(grid) {
    closeAllPinnedColumns(grid);
    let colGrid = null;
    let settings = null;
    const lstCols = grid.columns;
    const arColsToPin = new Array();
    for (let nCol = 0; nCol < lstCols.length; ++nCol) {
        colGrid = lstCols.byIndex(nCol);
        if (colGrid === null || GridUtils.isRowHeader(colGrid))
            continue;
        settings = colGrid.settings;
        if (settings !== null && settings !== undefined && settings.isPinned) {
            arColsToPin.push(colGrid);
        }
    }
    arColsToPin.sort((colOne, colTwo) => {
        if (colOne.settings.idxPinned === colTwo.settings.idxPinned) {
            return 0; //throw new Error("Pinned indices cannot be equal for different columns");
        }
        return colOne.settings.idxPinned < colTwo.settings.idxPinned ? -1 : 1;
    });
    let bPinned = false;
    for (let n = 0; n < arColsToPin.length; ++n) {
        colGrid = arColsToPin[n];
        if (isPinnableColumn(colGrid)) {
            new PinnedColumn(colGrid);
            bPinned = true;
        }
    }
    const colGrid0 = !bPinned ? null : grid.columns.byIndex(0);
    if (colGrid0 !== null && colGrid0 !== undefined) { //DG Bug from reading layout
        try {
            setTimeout(() => { colGrid0.visible = false; }, 100);
        }
        catch (e) {
            console.error("ERROR: Couldn't hide row header.");
        }
    }
}
export function isPinnedColumn(colGrid) {
    const grid = getGrid(colGrid);
    const dart = DG.toDart(grid);
    if (dart.m_arPinnedCols === undefined)
        return false;
    let colPinned = null;
    const nPinnedColCount = dart.m_arPinnedCols.length;
    for (let nColPin = 0; nColPin < nPinnedColCount; ++nColPin) {
        colPinned = dart.m_arPinnedCols[nColPin];
        if (DG.toDart(colPinned.m_colGrid) === DG.toDart(colGrid))
            return true;
    }
    return false;
}
export function isPinnableColumn(colGrid) {
    const b = isPinnedColumn(colGrid);
    if (b) {
        return false;
    }
    let grid = getGrid(colGrid);
    if (!(grid instanceof DG.Grid)) {
        grid = GridUtils.getInstalledGridForColumn(colGrid);
        if (!(grid instanceof DG.Grid)) {
            return false;
        }
    }
    //temporary disable to allow de-serialization from layout if(grid.canvas.offsetWidth <= colGrid.width) {
    //return false;
    //}
    if (colGrid.cellType === "html") {
        const renderer = GridUtils.getGridColumnRenderer(colGrid);
        if (!(renderer instanceof GridCellRendererEx)) {
            return false;
        }
    }
    return true;
}
let PINNED_COLUMNS_REGISTERED = false;
export function registerPinnedColumns() {
    if (PINNED_COLUMNS_REGISTERED)
        return;
    grok.events.onContextMenu.subscribe((args) => {
        PinnedUtils.handleContextMenu(args, (menu, colGridOrPinned, grid) => {
            if (colGridOrPinned instanceof PinnedColumn) {
                const colGrid = colGridOrPinned.getGridColumn();
                if (colGrid !== null && !GridUtils.isRowHeader(colGrid)) {
                    menu.item('Unpin Column', () => {
                        colGridOrPinned.close();
                    });
                }
                menu.item('Unpin All Columns', () => {
                    PinnedUtils.closeAllPinnedColumns(grid);
                });
            }
            else {
                menu.item('Pin Column', () => __awaiter(this, void 0, void 0, function* () {
                    PinnedUtils.addPinnedColumn(colGridOrPinned);
                }));
            }
        });
    });
    grok.events.onViewLayoutApplied.subscribe((layout) => {
        const view = layout.view;
        if (view === null) {
            console.error("View cannot be null; layout.view = null; grok.events.onViewLayoutApplied");
            return;
        }
        const itViewers = view.viewers;
        const arViewers = Array.from(itViewers);
        let viewer = null;
        const nViewerCount = arViewers.length;
        for (let n = 0; n < nViewerCount; ++n) {
            viewer = arViewers[n];
            if (viewer.type !== "Grid")
                continue;
            PinnedUtils.installPinnedColumns(viewer);
        }
    });
    PINNED_COLUMNS_REGISTERED = true;
}
export function handleContextMenu(args, fnMenuCallback) {
    const grid = args.args.context;
    if (!(grid instanceof DG.Grid)) {
        return;
    }
    const e = args.causedBy;
    //Check if we are on a pinned column
    const elem = document.elementFromPoint(e.clientX, e.clientY);
    if (elem instanceof HTMLCanvasElement) {
        const colPinned = findPinnedColumnByRoot(elem, grid);
        if (colPinned !== null) {
            let menu = args.args.menu;
            fnMenuCallback(menu, colPinned, grid);
            e.preventDefault();
            e.stopPropagation();
            return;
        }
    }
    //Regular Columns
    const cell = grid.hitTest(e.offsetX, e.offsetY);
    if (cell === undefined || cell === null || cell.cellType === null) //bug in DG , top left cell
        return;
    const colGrid = cell.gridColumn;
    if (!isPinnableColumn(colGrid)) {
        return;
    }
    if ((cell.isTableCell || cell.isColHeader) && (elem === grid.canvas || elem === grid.overlay)) {
        const menu = args.args.menu;
        fnMenuCallback(menu, colGrid, grid);
        e.preventDefault();
        e.stopPropagation();
        return;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUGlubmVkVXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJQaW5uZWRVdGlscy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFBQSxPQUFPLEtBQUssSUFBSSxNQUFNLG1CQUFtQixDQUFDO0FBQzFDLE9BQU8sS0FBSyxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDdEMsT0FBTyxLQUFLLFNBQVMsTUFBTSxvQkFBb0IsQ0FBQztBQUNoRCxPQUFPLEtBQUssV0FBVyxNQUFNLGVBQWUsQ0FBQztBQUM3QyxPQUFPLEVBQUMsWUFBWSxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFDNUMsT0FBTyxFQUFDLGtCQUFrQixFQUFDLE1BQU0sZ0NBQWdDLENBQUM7QUFHbEUsU0FBUyxPQUFPLENBQUMsT0FBdUI7SUFDdEMsSUFBSSxJQUFJLEdBQW9CLE9BQU8sQ0FBQyxJQUFJLENBQUM7SUFDekMsSUFBSSxJQUFJLEtBQUssSUFBSSxFQUFFO1FBQ2pCLElBQUksR0FBRyxTQUFTLENBQUMseUJBQXlCLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDcEQsSUFBRyxJQUFJLFlBQVksRUFBRSxDQUFDLElBQUk7WUFDeEIsT0FBTyxJQUFJLENBQUM7S0FDZjtJQUVELE9BQU8sSUFBSSxDQUFDO0FBQ2QsQ0FBQztBQUdELE1BQU0sVUFBVSx3QkFBd0IsQ0FBQyxJQUFjO0lBRXJELE1BQU0sSUFBSSxHQUFHLEVBQUUsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7SUFFN0IsTUFBTSxpQkFBaUIsR0FBRyxJQUFJLENBQUMsY0FBYyxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLE1BQU0sQ0FBQztJQUM3RixJQUFJLFNBQVMsR0FBRyxJQUFJLENBQUM7SUFDckIsSUFBSSxPQUFPLEdBQUcsQ0FBQyxDQUFDO0lBQ2hCLEtBQUksSUFBSSxFQUFFLEdBQUMsQ0FBQyxFQUFFLEVBQUUs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QUFDLElBQUssQ0FBQyxJQUFJLEtBQUssSUFBSSxDQUFDLE1BQU0sSUFBSSxJQUFJLEtBQUssSUFBSSxDQUFDLE9BQU8sQ0FBQyxFQUFFO1FBQzlGLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDO1FBQzVCLGNBQWMsQ0FBQyxJQUFJLEVBQUUsT0FBTyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ3BDLENBQUMsQ0FBQyxjQUFjLEVBQUUsQ0FBQztRQUNuQixDQUFDLENBQUMsZUFBZSxFQUFFLENBQUM7UUFDcEIsT0FBTztLQUNSO0FBQ0gsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIGdyb2sgZnJvbSAnZGF0YWdyb2stYXBpL2dyb2snO1xyXG5pbXBvcnQgKiBhcyBERyBmcm9tICdkYXRhZ3Jvay1hcGkvZGcnO1xyXG5pbXBvcnQgKiBhcyBHcmlkVXRpbHMgZnJvbSAnLi4vdXRpbHMvR3JpZFV0aWxzJztcclxuaW1wb3J0ICogYXMgUGlubmVkVXRpbHMgZnJvbSBcIi4vUGlubmVkVXRpbHNcIjtcclxuaW1wb3J0IHtQaW5uZWRDb2x1bW59IGZyb20gXCIuL1Bpbm5lZENvbHVtblwiO1xyXG5pbXBvcnQge0dyaWRDZWxsUmVuZGVyZXJFeH0gZnJvbSBcIi4uL3JlbmRlcmVyL0dyaWRDZWxsUmVuZGVyZXJFeFwiO1xyXG5pbXBvcnQge1RhYmxlVmlld30gZnJvbSBcImRhdGFncm9rLWFwaS9kZ1wiO1xyXG5cclxuZnVuY3Rpb24gZ2V0R3JpZChjb2xHcmlkIDogREcuR3JpZENvbHVtbikgOiBERy5HcmlkIHwgbnVsbCB7XHJcbiAgbGV0IGdyaWQgOiBERy5HcmlkIHwgbnVsbCA9IGNvbEdyaWQuZ3JpZDtcclxuICBpZiggZ3JpZCA9PT0gbnVsbCkge1xyXG4gICAgZ3JpZCA9IEdyaWRVdGlscy5nZXRJbnN0YWxsZWRHcmlkRm9yQ29sdW1uKGNvbEdyaWQpO1xyXG4gICAgaWYoZ3JpZCBpbnN0YW5jZW9mIERHLkdyaWQpXHJcbiAgICAgIHJldHVybiBncmlkO1xyXG4gIH1cclxuXHJcbiAgcmV0dXJuIGdyaWQ7XHJcbn1cclxuXHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0VG90YWxQaW5uZWRSb3dzSGVpZ2h0KGdyaWQgOiBERy5HcmlkKSA6IG51bWJlciB7XHJcblxyXG4gIGNvbnN0IGRhcnQgPSBERy50b0RhcnQoZ3JpZCk7XHJcblxyXG4gIGNvbnN0IG5QaW5uZWRSb3dzQ291bm50ID0gZGFydC5tX2FyUGlubmVkUm93cyA9PT0gdW5kZWZpbmVkID8gMCA6IGRhcnQubV9hclBpbm5lZFJvd3MubGVuZ3RoO1xyXG4gIGxldCByb3dQaW5uZWQgPSBudWxsO1xyXG4gIGxldCBuSGVpZ2h0ID0gMDtcclxuICBmb3IobGV0IG5SPTA7IG5SPG5QaW5uZWRSb3dzQ291bm50OyArK25SKSB7XHJcbiAgICByb3dQaW5uZWQgPSBkYXJ0Lm1fYXJQaW5uZWRSb3dzW25SXTtcclxuICAgIG5IZWlnaHQgKz0gcm93UGlubmVkLmdldEhlaWdodCgpO1xyXG4gIH1cclxuXHJcbiAgcmV0dXJuIG5IZWlnaHQ7XHJcbn1cclxuXHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0UGlubmVkQ29sdW1uTGVmdChjb2xQaW5uZWQgOiBQaW5uZWRDb2x1bW4pIDogbnVtYmVyIHtcclxuICBjb25zdCBncmlkID0gY29sUGlubmVkLmdldEdyaWRDb2x1bW4oKT8uZ3JpZDtcclxuICBjb25zdCBkYXJ0ID0gREcudG9EYXJ0KGdyaWQpO1xyXG4gIGxldCBjb2xQaW5uZWRUbXAgPSBudWxsO1xyXG5cclxuICBsZXQgblcgPSAwO1xyXG4gIGNvbnN0IG5QaW5uZWRDb2xDb3VudCA9ZGFydC5tX2FyUGlubmVkQ29scyA9PT0gdW5kZWZpbmVkID8gMCA6IGRhcnQubV9hclBpbm5lZENvbHMubGVuZ3RoO1xyXG4gIGZvcihsZXQgbj0wOyBuPG5QaW5uZWRDb2xDb3VudDsgKytuKSB7XHJcbiAgICBjb2xQaW5uZWRUbXAgPSBkYXJ0Lm1fYXJQaW5uZWRDb2xzW25dO1xyXG4gICAgaWYoY29sUGlubmVkID09PSBjb2xQaW5uZWRUbXApIHtcclxuICAgICAgYnJlYWs7XHJcbiAgICB9XHJcbiAgICBuVyArPSBjb2xQaW5uZWRUbXAuZ2V0V2lkdGgoKTtcclxuICB9XHJcblxyXG4gIHJldHVybiBuVztcclxufVxyXG5cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBzZXRQaW5uZWRDb2x1bW5XaWR0aChjb2xQaW5uZWQgOiBQaW5uZWRDb2x1bW4sIG5XIDogbnVtYmVyKSA6IHZvaWQge1xyXG4gIGNvbnN0IGdyaWQgPSBjb2xQaW5uZWQuZ2V0R3JpZENvbHVtbigpPy5ncmlkO1xyXG4gIGlmKGdyaWQgPT09IG51bGwgfHwgZ3JpZCA9PT0gdW5kZWZpbmVkKVxyXG4gICAgcmV0dXJuO1xyXG5cclxuICBjb25zdCBkYXJ0ID0gREcudG9EYXJ0KGdyaWQpO1xyXG4gIGxldCBjb2xQaW5uZWRUbXAgPSBudWxsO1xyXG4gIGNvbnN0IG5QaW5uZWRDb2xDb3VudCA9ZGFydC5tX2FyUGlubmVkQ29scyA9PT0gdW5kZWZpbmVkID8gMCA6IGRhcnQubV9hclBpbm5lZENvbHMubGVuZ3RoO1xyXG4gIGxldCBuPTA7XHJcbiAgZm9yKDsgbjxuUGlubmVkQ29sQ291bnQ7ICsrbikge1xyXG4gICAgY29sUGlubmVkVG1wID0gZGFydC5tX2FyUGlubmVkQ29sc1tuXTtcclxuICAgIGlmKGNvbFBpbm5lZCA9PT0gY29sUGlubmVkVG1wKSB7XHJcbiAgICAgIGJyZWFrO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgaWYobiA9PT0gblBpbm5lZENvbENvdW50KVxyXG4gICAgcmV0dXJuO1xyXG5cclxuICBsZXQgZUNhbnZhcyA9IGNvbFBpbm5lZFRtcC5nZXRSb290KCk7XHJcbiAgaWYoZUNhbnZhcyA9PT0gbnVsbClcclxuICAgIHJldHVybjtcclxuXHJcbiAgLy9UaGlzIFBpbm5lZCBDb2x1bW5cclxuICBjb25zdCBuV0NvbCA9IGNvbFBpbm5lZC5nZXRXaWR0aCgpO1xyXG4gIGxldCBuWERpZmYgPSBuVyAtIG5XQ29sO1xyXG4gIGlmKGdyaWQuY2FudmFzLm9mZnNldFdpZHRoIC0gblhEaWZmIDwgMjApIHtcclxuICAgIG5YRGlmZiA9IGdyaWQuY2FudmFzLm9mZnNldFdpZHRoIC0gMjA7XHJcbiAgICBuVyA9IG5XQ29sICsgblhEaWZmO1xyXG4gIH1cclxuICBlQ2FudmFzLndpZHRoID0gblcqd2luZG93LmRldmljZVBpeGVsUmF0aW87XHJcbiAgZUNhbnZhcy5zdHlsZS53aWR0aCA9IG5XLnRvU3RyaW5nKCkgKyBcInB4XCI7XHJcbiAgLy9jb25zb2xlLmxvZygnbldXV0NvbDogJyArIG5XICsgXCIgblhEaWZmPSBcIiArIG5YRGlmZiArIFwiIG5ldyBXPSBcIiArIG5YRGlmZik7XHJcblxyXG4gIGNvbnN0IGcgPSBlQ2FudmFzLmdldENvbnRleHQoJzJkJyk7XHJcbiAgY29sUGlubmVkLnBhaW50KGcsIGdyaWQpO1xyXG5cclxuICArK247XHJcbiAgZm9yKDsgbjxuUGlubmVkQ29sQ291bnQ7ICsrbikge1xyXG4gICAgY29sUGlubmVkVG1wID0gZGFydC5tX2FyUGlubmVkQ29sc1tuXTtcclxuICAgIGVDYW52YXMgPSBjb2xQaW5uZWRUbXAuZ2V0Um9vdCgpO1xyXG4gICAgaWYoZUNhbnZhcyA9PT0gbnVsbClcclxuICAgICAgY29udGludWU7XHJcblxyXG4gICAgZUNhbnZhcy5zdHlsZS5sZWZ0ID0gKGVDYW52YXMub2Zmc2V0TGVmdCArIG5YRGlmZikudG9TdHJpbmcoKSArIFwicHhcIjtcclxuICAgfVxyXG5cclxuICAvL0dyaWRcclxuICBncmlkLmNhbnZhcy5zdHlsZS5sZWZ0ID0gKGdyaWQuY2FudmFzLm9mZnNldExlZnQgKyBuWERpZmYpLnRvU3RyaW5nKCkgKyBcInB4XCI7XHJcbiAgZ3JpZC5vdmVybGF5LnN0eWxlLmxlZnQ9IChncmlkLm92ZXJsYXkub2Zmc2V0TGVmdCArIG5YRGlmZikudG9TdHJpbmcoKSArIFwicHhcIjtcclxuXHJcbiAgZ3JpZC5jYW52YXMuc3R5bGUud2lkdGggPSAoZ3JpZC5jYW52YXMub2Zmc2V0V2lkdGggLSBuWERpZmYpLnRvU3RyaW5nKCkgKyBcInB4XCI7XHJcbiAgZ3JpZC5vdmVybGF5LnN0eWxlLndpZHRoPSAoZ3JpZC5vdmVybGF5Lm9mZnNldFdpZHRoIC0gblhEaWZmKS50b1N0cmluZygpICsgXCJweFwiO1xyXG4gIGdyaWQuaW52YWxpZGF0ZSgpO1xyXG59XHJcblxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGdldFRvdGFsUGlubmVkQ29sc1dpZHRoKGdyaWQgOiBERy5HcmlkKSA6IG51bWJlciB7XHJcbiAgY29uc3QgZGFydCA9IERHLnRvRGFydChncmlkKTtcclxuICBjb25zdCBuUGlubmVkQ29sc0NvdW5udCA9IGRhcnQubV9hclBpbm5lZENvbHMgPT09IHVuZGVmaW5lZCA/IDAgOiBkYXJ0Lm1fYXJQaW5uZWRDb2xzLmxlbmd0aDtcclxuICBsZXQgY29sUGlubmVkID0gbnVsbDtcclxuICBsZXQgbldpZHRoID0gMDtcclxuICBmb3IobGV0IG5SPTA7IG5SPG5QaW5uZWRDb2xzQ291bm50OyArK25SKSB7XHJcbiAgICBjb2xQaW5uZWQgPSBkYXJ0Lm1fYXJQaW5uZWRDb2xzW25SXTtcclxuICAgIG5XaWR0aCArPSBjb2xQaW5uZWQuZ2V0V2lkdGgoKTtcclxuICB9XHJcblxyXG4gIHJldHVybiBuV2lkdGg7XHJcbn1cclxuXHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZmluZFBpbm5lZENvbHVtbkJ5Um9vdChlQ2FudmFzIDogSFRNTENhbnZhc0VsZW1lbnQsIGdyaWQgOiBERy5HcmlkKSA6IFBpbm5lZENvbHVtbiB8IG51bGwge1xyXG4gIGNvbnN0IGRhcnQgPSBERy50b0RhcnQoZ3JpZCk7XHJcbiAgbGV0IGNvbFBpbm5lZCA9IG51bGw7XHJcbiAgY29uc3QgblBpbm5lZENvbENvdW50ID1kYXJ0Lm1fYXJQaW5uZWRDb2xzID09PSB1bmRlZmluZWQgPyAwIDogZGFydC5tX2FyUGlubmVkQ29scy5sZW5ndGg7XHJcbiAgZm9yKGxldCBuPTA7IG48blBpbm5lZENvbENvdW50OyArK24pIHtcclxuICAgIGNvbFBpbm5lZCA9IGRhcnQubV9hclBpbm5lZENvbHNbbl07XHJcbiAgICBpZihjb2xQaW5uZWQuZ2V0Um9vdCgpID09PSBlQ2FudmFzKSB7XHJcbiAgICAgIHJldHVybiBjb2xQaW5uZWQ7XHJcbiAgICB9XHJcbiAgfVxyXG4gIHJldHVybiBudWxsO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0UGlubmVkQ29sdW1uQ291bnQoZ3JpZCA6IERHLkdyaWQpIDogbnVtYmVyIHtcclxuICBjb25zdCBkYXJ0ID0gREcudG9EYXJ0KGdyaWQpO1xyXG4gIGNvbnN0IG5QaW5uZWRDb2xDb3VudCA9ZGFydC5tX2FyUGlubmVkQ29scyA9PT0gdW5kZWZpbmVkID8gMCA6IGRhcnQubV9hclBpbm5lZENvbHMubGVuZ3RoO1xyXG4gIHJldHVybiBuUGlubmVkQ29sQ291bnQ7XHJcbn1cclxuXHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0UGlubmVkQ29sdW1uKG5JZHggOiBudW1iZXIsIGdyaWQgOiBERy5HcmlkKSA6IFBpbm5lZENvbHVtbiB7XHJcbiAgaWYobklkeCA8IDApIHtcclxuICAgIHRocm93IG5ldyBFcnJvcihcIlBpbm5lZCBjb2x1bW4gaW5kZXggY2Fubm90IGJlIG5lZ2F0aXZlOiBcIiArIG5JZHgpO1xyXG4gIH1cclxuXHJcbiAgY29uc3QgZGFydCA9IERHLnRvRGFydChncmlkKTtcclxuICBjb25zdCBuUGlubmVkQ29sQ291bnQgPWRhcnQubV9hclBpbm5lZENvbHMgPT09IHVuZGVmaW5lZCA/IDAgOiBkYXJ0Lm1fYXJQaW5uZWRDb2xzLmxlbmd0aDtcclxuICBpZihuSWR4ID49IG5QaW5uZWRDb2xDb3VudCkge1xyXG4gICAgdGhyb3cgbmV3IEVycm9yKFwiUGlubmVkIGNvbHVtbiBpbmRleCBjaXMgb3V0IG9mIGJvdW5kcyBbMCw6IFwiICsgKG5QaW5uZWRDb2xDb3VudCAtMSkgKyBcIl1cIik7XHJcbiAgfVxyXG5cclxuICByZXR1cm4gZGFydC5tX2FyUGlubmVkQ29sc1tuSWR4XTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGFkZFBpbm5lZENvbHVtbihjb2xHcmlkIDogREcuR3JpZENvbHVtbikgOiBQaW5uZWRDb2x1bW4ge1xyXG4gIGNvbnN0IGNvbFBpbm5lZCA9IG5ldyBQaW5uZWRDb2x1bW4oY29sR3JpZCk7XHJcbiAgcmV0dXJuIGNvbFBpbm5lZDtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGNsb3NlQWxsUGlubmVkQ29sdW1ucyhncmlkIDogREcuR3JpZCkgOiB2b2lkIHtcclxuICBjb25zdCBkYXJ0ID0gREcudG9EYXJ0KGdyaWQpO1xyXG4gIGxldCBjb2xQaW5uZWQgPSBudWxsO1xyXG4gIGNvbnN0IG5QaW5uZWRDb2xDb3VudCA9ZGFydC5tX2FyUGlubmVkQ29scyA9PT0gdW5kZWZpbmVkID8gMCA6IGRhcnQubV9hclBpbm5lZENvbHMubGVuZ3RoO1xyXG4gIGZvcihsZXQgbj0xOyBuPG5QaW5uZWRDb2xDb3VudDsgKytuKSB7XHJcbiAgICBjb2xQaW5uZWQgPSBkYXJ0Lm1fYXJQaW5uZWRDb2xzWzFdOyAvLzAgaXMgbm90IGEgYnVnXHJcbiAgICBjb2xQaW5uZWQuY2xvc2UoKTtcclxuICB9XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBpbnN0YWxsUGlubmVkQ29sdW1ucyhncmlkIDogREcuR3JpZCkgOiB2b2lkIHtcclxuICBjbG9zZUFsbFBpbm5lZENvbHVtbnMoZ3JpZCk7XHJcblxyXG4gIGxldCBjb2xHcmlkID0gbnVsbDtcclxuICBsZXQgc2V0dGluZ3MgOiBhbnkgPSBudWxsO1xyXG4gIGNvbnN0IGxzdENvbHMgPSBncmlkLmNvbHVtbnM7XHJcbiAgY29uc3QgYXJDb2xzVG9QaW4gPSBuZXcgQXJyYXk8REcuR3JpZENvbHVtbj4oKTtcclxuXHJcbiAgZm9yKGxldCBuQ29sPTA7bkNvbDxsc3RDb2xzLmxlbmd0aDsgKytuQ29sKSB7XHJcbiAgICBjb2xHcmlkID0gbHN0Q29scy5ieUluZGV4KG5Db2wpO1xyXG4gICAgaWYoY29sR3JpZCA9PT0gbnVsbCB8fCBHcmlkVXRpbHMuaXNSb3dIZWFkZXIoY29sR3JpZCkpXHJcbiAgICAgIGNvbnRpbnVlO1xyXG5cclxuICAgIHNldHRpbmdzID0gY29sR3JpZC5zZXR0aW5ncztcclxuICAgIGlmKHNldHRpbmdzICE9PSBudWxsICYmIHNldHRpbmdzICE9PSB1bmRlZmluZWQgJiYgc2V0dGluZ3MuaXNQaW5uZWQpIHtcclxuICAgICAgYXJDb2xzVG9QaW4ucHVzaChjb2xHcmlkKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIGFyQ29sc1RvUGluLnNvcnQoKGNvbE9uZSwgY29sVHdvKSA9PiB7XHJcbiAgICBpZihjb2xPbmUuc2V0dGluZ3MuaWR4UGlubmVkID09PSBjb2xUd28uc2V0dGluZ3MuaWR4UGlubmVkKSB7XHJcbiAgICAgIHJldHVybiAwOy8vdGhyb3cgbmV3IEVycm9yKFwiUGlubmVkIGluZGljZXMgY2Fubm90IGJlIGVxdWFsIGZvciBkaWZmZXJlbnQgY29sdW1uc1wiKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gY29sT25lLnNldHRpbmdzLmlkeFBpbm5lZCA8IGNvbFR3by5zZXR0aW5ncy5pZHhQaW5uZWQgPyAtMSA6IDE7XHJcbiAgfSk7XHJcblxyXG4gIGxldCBiUGlubmVkID0gZmFsc2U7XHJcbiAgZm9yKGxldCBuPTA7bjxhckNvbHNUb1Bpbi5sZW5ndGg7ICsrbikge1xyXG4gICAgY29sR3JpZCA9IGFyQ29sc1RvUGluW25dO1xyXG4gICAgaWYoaXNQaW5uYWJsZUNvbHVtbihjb2xHcmlkKSkge1xyXG4gICAgICBuZXcgUGlubmVkQ29sdW1uKGNvbEdyaWQpO1xyXG4gICAgICBiUGlubmVkID0gdHJ1ZTtcclxuICAgIH1cclxuICB9XHJcblxyXG5cclxuICBjb25zdCBjb2xHcmlkMCA9ICFiUGlubmVkID8gbnVsbCA6IGdyaWQuY29sdW1ucy5ieUluZGV4KDApO1xyXG4gIGlmKGNvbEdyaWQwICE9PSBudWxsICYmIGNvbEdyaWQwICE9PSB1bmRlZmluZWQpIHsvL0RHIEJ1ZyBmcm9tIHJlYWRpbmcgbGF5b3V0XHJcbiAgICB0cnl7XHJcbiAgICAgIHNldFRpbWVvdXQoKCkgPT4ge2NvbEdyaWQwLnZpc2libGUgPSBmYWxzZX0sIDEwMCk7XHJcbiAgICB9XHJcbiAgICBjYXRjaChlKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoXCJFUlJPUjogQ291bGRuJ3QgaGlkZSByb3cgaGVhZGVyLlwiKTtcclxuICAgIH1cclxuICB9XHJcblxyXG59XHJcblxyXG5cclxuXHJcblxyXG5leHBvcnQgZnVuY3Rpb24gaXNQaW5uZWRDb2x1bW4oY29sR3JpZCA6IERHLkdyaWRDb2x1bW4pIDogYm9vbGVhbiB7XHJcbiAgY29uc3QgZ3JpZCA9IGdldEdyaWQoY29sR3JpZCk7XHJcbiAgY29uc3QgZGFydCA9IERHLnRvRGFydChncmlkKTtcclxuXHJcbiAgaWYoZGFydC5tX2FyUGlubmVkQ29scyA9PT0gdW5kZWZpbmVkKVxyXG4gICAgcmV0dXJuIGZhbHNlO1xyXG5cclxuICBsZXQgY29sUGlubmVkID0gbnVsbDtcclxuICBjb25zdCBuUGlubmVkQ29sQ291bnQgPSBkYXJ0Lm1fYXJQaW5uZWRDb2xzLmxlbmd0aDtcclxuICBmb3IobGV0IG5Db2xQaW49MDsgbkNvbFBpbjxuUGlubmVkQ29sQ291bnQ7ICsrbkNvbFBpbikge1xyXG4gICAgY29sUGlubmVkID0gZGFydC5tX2FyUGlubmVkQ29sc1tuQ29sUGluXTtcclxuICAgIGlmKERHLnRvRGFydChjb2xQaW5uZWQubV9jb2xHcmlkKSA9PT0gREcudG9EYXJ0KGNvbEdyaWQpKVxyXG4gICAgICByZXR1cm4gdHJ1ZTtcclxuICB9XHJcblxyXG4gIHJldHVybiBmYWxzZTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGlzUGlubmFibGVDb2x1bW4oY29sR3JpZCA6IERHLkdyaWRDb2x1bW4pIDogYm9vbGVhbiB7XHJcbiAgY29uc3QgYiA9IGlzUGlubmVkQ29sdW1uKGNvbEdyaWQpO1xyXG4gIGlmKGIpIHtcclxuICAgIHJldHVybiBmYWxzZTtcclxuICB9XHJcblxyXG5cclxuICBsZXQgZ3JpZCA6IERHLkdyaWQgfCBudWxsID0gZ2V0R3JpZChjb2xHcmlkKTtcclxuICBpZighKGdyaWQgaW5zdGFuY2VvZiBERy5HcmlkKSkge1xyXG4gICAgZ3JpZCA9IEdyaWRVdGlscy5nZXRJbnN0YWxsZWRHcmlkRm9yQ29sdW1uKGNvbEdyaWQpO1xyXG5cclxuICAgIGlmKCEoZ3JpZCBpbnN0YW5jZW9mIERHLkdyaWQpKSB7XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8vdGVtcG9yYXJ5IGRpc2FibGUgdG8gYWxsb3cgZGUtc2VyaWFsaXphdGlvbiBmcm9tIGxheW91dCBpZihncmlkLmNhbnZhcy5vZmZzZXRXaWR0aCA8PSBjb2xHcmlkLndpZHRoKSB7XHJcbiAgLy9yZXR1cm4gZmFsc2U7XHJcbiAgLy99XHJcblxyXG4gIGlmKGNvbEdyaWQuY2VsbFR5cGUgPT09IFwiaHRtbFwiKSB7XHJcbiAgICBjb25zdCByZW5kZXJlciA9IEdyaWRVdGlscy5nZXRHcmlkQ29sdW1uUmVuZGVyZXIoY29sR3JpZCk7XHJcbiAgICBpZighKHJlbmRlcmVyIGluc3RhbmNlb2YgR3JpZENlbGxSZW5kZXJlckV4KSkge1xyXG4gICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICByZXR1cm4gdHJ1ZTtcclxufVxyXG5cclxuXHJcbmxldCBQSU5ORURfQ09MVU1OU19SRUdJU1RFUkVEID0gZmFsc2U7XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gcmVnaXN0ZXJQaW5uZWRDb2x1bW5zKCkge1xyXG4gIGlmKFBJTk5FRF9DT0xVTU5TX1JFR0lTVEVSRUQpXHJcbiAgICByZXR1cm47XHJcblxyXG4gIGdyb2suZXZlbnRzLm9uQ29udGV4dE1lbnUuc3Vic2NyaWJlKChhcmdzIDogYW55KSA9PiB7XHJcbiAgICBQaW5uZWRVdGlscy5oYW5kbGVDb250ZXh0TWVudShhcmdzLCAobWVudSA6IERHLk1lbnUsIGNvbEdyaWRPclBpbm5lZCA6IERHLkdyaWRDb2x1bW4gfCBQaW5uZWRDb2x1bW4sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3JpZCA6IERHLkdyaWQpID0+IHtcclxuICAgICAgaWYgKGNvbEdyaWRPclBpbm5lZCBpbnN0YW5jZW9mIFBpbm5lZENvbHVtbikge1xyXG4gICAgICAgIGNvbnN0IGNvbEdyaWQgPSBjb2xHcmlkT3JQaW5uZWQuZ2V0R3JpZENvbHVtbigpO1xyXG4gICAgICAgIGlmIChjb2xHcmlkICE9PSBudWxsICYmICFHcmlkVXRpbHMuaXNSb3dIZWFkZXIoY29sR3JpZCkpIHtcclxuICAgICAgICAgIG1lbnUuaXRlbSgnVW5waW4gQ29sdW1uJywgKCkgPT4ge1xyXG4gICAgICAgICAgICBjb2xHcmlkT3JQaW5uZWQuY2xvc2UoKTtcclxuICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBtZW51Lml0ZW0oJ1VucGluIEFsbCBDb2x1bW5zJywgKCkgPT4ge1xyXG4gICAgICAgICAgUGlubmVkVXRpbHMuY2xvc2VBbGxQaW5uZWRDb2x1bW5zKGdyaWQpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIG1lbnUuaXRlbSgnUGluIENvbHVtbicsIGFzeW5jICgpID0+IHtcclxuICAgICAgICAgIFBpbm5lZFV0aWxzLmFkZFBpbm5lZENvbHVtbihjb2xHcmlkT3JQaW5uZWQpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9KTtcclxuXHJcbiAgZ3Jvay5ldmVudHMub25WaWV3TGF5b3V0QXBwbGllZC5zdWJzY3JpYmUoKGxheW91dCA6IERHLlZpZXdMYXlvdXQpID0+IHtcclxuICAgIGNvbnN0IHZpZXcgOiBERy5UYWJsZVZpZXcgPSBsYXlvdXQudmlldyBhcyBUYWJsZVZpZXc7XHJcbiAgICBpZih2aWV3ID09PSBudWxsKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoXCJWaWV3IGNhbm5vdCBiZSBudWxsOyBsYXlvdXQudmlldyA9IG51bGw7IGdyb2suZXZlbnRzLm9uVmlld0xheW91dEFwcGxpZWRcIik7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBpdFZpZXdlcnMgPSB2aWV3LnZpZXdlcnM7XHJcbiAgICBjb25zdCBhclZpZXdlcnMgPSBBcnJheS5mcm9tKGl0Vmlld2Vycyk7XHJcblxyXG4gICAgbGV0IHZpZXdlciA9IG51bGw7XHJcbiAgICBjb25zdCBuVmlld2VyQ291bnQgPSBhclZpZXdlcnMubGVuZ3RoO1xyXG4gICAgZm9yIChsZXQgbiA9IDA7IG4gPCBuVmlld2VyQ291bnQ7ICsrbikge1xyXG4gICAgICB2aWV3ZXIgPSBhclZpZXdlcnNbbl07XHJcbiAgICAgIGlmICh2aWV3ZXIudHlwZSAhPT0gXCJHcmlkXCIpXHJcbiAgICAgICAgY29udGludWU7XHJcblxyXG4gICAgICBQaW5uZWRVdGlscy5pbnN0YWxsUGlubmVkQ29sdW1ucyh2aWV3ZXIgYXMgREcuR3JpZCk7XHJcbiAgICB9XHJcbiAgfSk7XHJcblxyXG5cclxuICBQSU5ORURfQ09MVU1OU19SRUdJU1RFUkVEID0gdHJ1ZTtcclxufVxyXG5cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBoYW5kbGVDb250ZXh0TWVudShhcmdzIDogYW55LCBmbk1lbnVDYWxsYmFjayA6IEZ1bmN0aW9uKSA6IHZvaWQge1xyXG5cclxuICBjb25zdCBncmlkID0gYXJncy5hcmdzLmNvbnRleHQ7XHJcbiAgaWYgKCEoZ3JpZCBpbnN0YW5jZW9mIERHLkdyaWQpKSB7XHJcbiAgICByZXR1cm47XHJcbiAgfVxyXG4gIGNvbnN0IGUgPSBhcmdzLmNhdXNlZEJ5O1xyXG4gIC8vQ2hlY2sgaWYgd2UgYXJlIG9uIGEgcGlubmVkIGNvbHVtblxyXG4gIGNvbnN0IGVsZW0gPSBkb2N1bWVudC5lbGVtZW50RnJvbVBvaW50KGUuY2xpZW50WCwgZS5jbGllbnRZKTtcclxuICBpZiAoZWxlbSBpbnN0YW5jZW9mIEhUTUxDYW52YXNFbGVtZW50KSB7XHJcbiAgICBjb25zdCBjb2xQaW5uZWQgPSBmaW5kUGlubmVkQ29sdW1uQnlSb290KGVsZW0sIGdyaWQpO1xyXG4gICAgaWYgKGNvbFBpbm5lZCAhPT0gbnVsbCkge1xyXG4gICAgICBsZXQgbWVudSA9IGFyZ3MuYXJncy5tZW51O1xyXG4gICAgICBmbk1lbnVDYWxsYmFjayhtZW51LCBjb2xQaW5uZWQsIGdyaWQpO1xyXG4gICAgICBlLnByZXZlbnREZWZhdWx0KCk7XHJcbiAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuICB9XHJcbiAgLy9SZWd1bGFyIENvbHVtbnNcclxuICBjb25zdCBjZWxsID0gZ3JpZC5oaXRUZXN0KGUub2Zmc2V0WCwgZS5vZmZzZXRZKTtcclxuICBpZiAoY2VsbCA9PT0gdW5kZWZpbmVkIHx8IGNlbGwgPT09IG51bGwgfHwgY2VsbC5jZWxsVHlwZSA9PT0gbnVsbCkgLy9idWcgaW4gREcgLCB0b3AgbGVmdCBjZWxsXHJcbiAgICByZXR1cm47XHJcblxyXG4gIGNvbnN0IGNvbEdyaWQgPSBjZWxsLmdyaWRDb2x1bW47XHJcbiAgaWYoIWlzUGlubmFibGVDb2x1bW4oY29sR3JpZCkpIHtcclxuICAgIHJldHVybjtcclxuICB9XHJcblxyXG4gIGlmICgoY2VsbC5pc1RhYmxlQ2VsbCB8fCBjZWxsLmlzQ29sSGVhZGVyKSAgJiYgKGVsZW0gPT09IGdyaWQuY2FudmFzIHx8IGVsZW0gPT09IGdyaWQub3ZlcmxheSkpIHtcclxuICAgIGNvbnN0IG1lbnUgPSBhcmdzLmFyZ3MubWVudTtcclxuICAgIGZuTWVudUNhbGxiYWNrKG1lbnUsIGNvbEdyaWQsIGdyaWQpO1xyXG4gICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcclxuICAgIHJldHVybjtcclxuICB9XHJcbn1cclxuIl19