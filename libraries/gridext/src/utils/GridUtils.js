import * as DG from 'datagrok-api/dg';
import * as TextUtils from "./TextUtils";
/*
const canvas = ui.canvas(200*r, 300*r);

cellGrid.renderer.render(10, 10, 200, 300);

const r = window.devicePixelRatio;
x = r * x; y = r * y;
w = r * w; h = r * h;
*/
export function getGridDartPopupMenu() {
    let eDiv = null;
    const cDiv = document.getElementsByClassName('d4-menu-item-container d4-vert-menu d4-menu-popup');
    for (let n = 0; n < cDiv.length; ++n) {
        eDiv = cDiv.item(n);
        return eDiv;
    }
    return null;
}
export function getToolIconDiv(grid) {
    const cImg = document.getElementsByClassName('grok-icon grok-font-icon-menu');
    let eDivHamb = null;
    let eParent = null;
    for (let n = 0; n < cImg.length; ++n) {
        eDivHamb = cImg.item(n).parentElement;
        if (eDivHamb == null)
            return null;
        if ((eDivHamb === null || eDivHamb === void 0 ? void 0 : eDivHamb.getAttribute('column_name')) !== null) { //'data') === 'ColHamb') {
            eParent = eDivHamb.parentElement;
            while (eParent !== null) {
                if (eParent === grid.root)
                    return eDivHamb;
                eParent = eParent.parentElement;
            }
        }
    }
    return null;
}
export function isHitTestOnElement(eElem, eMouse) {
    const eElemHit = document.elementFromPoint(eMouse.clientX, eMouse.clientY);
    const b = eElemHit == eElem;
    return b;
}
export function isRowHeader(colGrid) {
    return colGrid.idx === 0 || colGrid.name === 'row header';
}
export function getInstalledGridForColumn(colGrid) {
    const dart = DG.toDart(colGrid);
    if (!(dart.m_grid instanceof DG.Grid))
        return null;
    return dart.m_grid;
}
export function installGridForColumn(grid, colGrid) {
    if (colGrid.grid instanceof DG.Grid)
        return false;
    const dart = DG.toDart(colGrid);
    if (dart.m_grid instanceof DG.Grid)
        return false;
    dart.m_grid = grid;
    return true;
}
export function setGridColumnRenderer(colGrid, renderer) {
    const dart = DG.toDart(colGrid);
    dart.m_renderer = renderer;
}
export function getGridColumnRenderer(colGrid) {
    const dart = DG.toDart(colGrid);
    const renderer = dart.m_renderer;
    if (renderer === undefined)
        return null;
    return renderer;
}
export function getGridColumnHeaderHeight(grid) {
    const options = grid.getOptions(true);
    let nHColHeader = options.look.colHeaderHeight;
    if (nHColHeader === null || nHColHeader === undefined) { //DG bug
        const cellGrid = grid.hitTest(2, 2); //.cell(col.name, 0);
        if (cellGrid !== null) {
            const rc = cellGrid.bounds;
            return rc.y;
            //console.log('rc.y ' + rc.y + " rc.h= " + rc.height + " row " + cellGrid.gridRow + " name " +  cellGrid.gridColumn.name);
        }
    }
    return nHColHeader;
}
export function getGridRowHeight(grid) {
    const options = grid.getOptions(true);
    const nHRow = options.look.rowHeight;
    if (nHRow === null || nHRow === undefined) { //DG bug
        let col = null;
        const nColCount = grid.columns.length;
        for (let nCol = 0; nCol < nColCount; ++nCol) {
            col = grid.columns.byIndex(nCol);
            if (col === null || !col.visible)
                continue;
            const cellGrid = grid.cell(col.name, 0);
            const rc = cellGrid.bounds;
            return rc.height;
        }
        return -1;
    }
    return nHRow;
}
export function getGridVisibleRowCount(grid) {
    const dframe = grid.dataFrame;
    const bitsetFilter = dframe.filter;
    const nRowCount = bitsetFilter.trueCount;
    return nRowCount;
}
export function fillVisibleViewportRows(arMinMaxRowIdxs, grid) {
    if (arMinMaxRowIdxs.length !== 2)
        throw new Error("Array to cobtain indices must have the length 2.");
    const scroll = grid.vertScroll;
    const nRowMin = Math.floor(scroll.min);
    let nRowMax = Math.ceil(scroll.max);
    const nRowCount = getGridVisibleRowCount(grid);
    if (nRowMax >= nRowCount) {
        nRowMax = nRowCount - 1;
    }
    arMinMaxRowIdxs[0] = nRowMin;
    arMinMaxRowIdxs[1] = nRowMax;
    //console.log('min: ' + scroll.min + " max: " + scroll.max + ' nRowMax ' + nRowMax + " nVisRowCount: " + nRowCount);
}
export function fillVisibleViewportGridCells(arColRowIdxs, grid) {
    if (arColRowIdxs.length !== 4)
        throw new Error("Array to cobtain bound row column indices must have the length 4.");
    const arRowIdxs = [];
    const arColIdxs = [];
    const lstVisibleCells = grid.getVisibleCells();
    for (let cellGTmp of lstVisibleCells) {
        if (!arRowIdxs.includes(cellGTmp.gridRow))
            arRowIdxs.push(cellGTmp.gridRow);
        if (!arColIdxs.includes(cellGTmp.gridColumn.idx))
            arColIdxs.push(cellGTmp.gridColumn.idx);
    }
    const nRowMin = arRowIdxs.length === 0 ? -1 : arRowIdxs[0];
    const nRowMax = arRowIdxs.length === 0 ? -2 : arRowIdxs[arRowIdxs.length - 1];
    arColRowIdxs[0] = arColIdxs.length === 0 ? -1 : arColIdxs[0];
    arColRowIdxs[1] = arColIdxs.length === 0 ? -2 : arColIdxs[arColIdxs.length - 1];
    arColRowIdxs[2] = nRowMin;
    arColRowIdxs[3] = nRowMax;
}
export function getActiveGridRow(grid) {
    const dframe = grid.dataFrame;
    const nRowTableActive = dframe.currentRow.idx;
    const nGridColCount = grid.columns.length;
    let colGrid = null;
    let cellGrid = null;
    for (let nCol = 0; nCol < nGridColCount; ++nCol) {
        colGrid = grid.columns.byIndex(nCol);
        if (colGrid === null || colGrid === void 0 ? void 0 : colGrid.visible) {
            const nGridRowCount = dframe.filter.trueCount;
            for (let nR = 0; nR < nGridRowCount; ++nR) {
                cellGrid = grid.cell(colGrid.name, nR);
                if (cellGrid.tableRowIndex === null || nRowTableActive === null)
                    continue;
                if (cellGrid.tableRowIndex === nRowTableActive)
                    return nR;
            }
            return -1;
        }
    }
    return -1;
}
const m_mapScaledFonts = new Map();
export function scaleFont(font, fFactor) {
    if (fFactor === 1.0) {
        return font;
    }
    const strKey = font + fFactor.toString();
    let fontScaled = m_mapScaledFonts.get(strKey);
    if (fontScaled !== undefined)
        return fontScaled;
    const nFontSize = TextUtils.getFontSize(font);
    fontScaled = TextUtils.setFontSize(font, Math.ceil(nFontSize * fFactor));
    m_mapScaledFonts.set(strKey, fontScaled);
    return fontScaled;
}
export function paintColHeaderCell(g, nX, nY, nW, nH, colGrid) {
    if (g === null)
        return;
    g.fillStyle = "white";
    g.fillRect(nX * window.devicePixelRatio, nY * window.devicePixelRatio, nW * window.devicePixelRatio, nH * window.devicePixelRatio);
    const grid = colGrid.grid;
    const options = grid.getOptions(true);
    const font = options.look.colHeaderFont == null || options.look.colHeaderFont === undefined ? "bold 14px Volta Text, Arial" : options.look.colHeaderFont;
    const fontNew = scaleFont(font, window.devicePixelRatio);
    g.font = fontNew;
    let str = TextUtils.trimText(colGrid.name, g, nW);
    const tm = g.measureText(str);
    const nWLabel = tm.width;
    const nAscent = Math.abs(tm.actualBoundingBoxAscent);
    const nDescent = tm.actualBoundingBoxDescent;
    const nHFont = nAscent + nDescent; // + 2*nYInset;
    const nHH = nH * window.devicePixelRatio;
    g.textAlign = 'start';
    g.fillStyle = "Black";
    const nXX = nX * window.devicePixelRatio + Math.ceil(3 * window.devicePixelRatio); //((nW*window.devicePixelRatio - nWLabel) >> 1);
    const nYY = (nY * window.devicePixelRatio + nHH - Math.ceil(3 * window.devicePixelRatio)); //-2*window.devicePixelRatio);
    g.fillText(str, nXX, nYY);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiR3JpZFV0aWxzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiR3JpZFV0aWxzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sS0FBSyxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFFdEMsT0FBTyxLQUFLLFNBQVMsTUFBTSxhQUFhLENBQUM7QUFDekM7Ozs7Ozs7O0VBUUU7QUFFRixNQUFNLFVBQVUsb0JBQW9CO0lBRWxDLElBQUksSUFBSSxHQUFHLElBQUksQ0FBQztJQUNoQixNQUFNLElBQUksR0FBRyxRQUFRLENBQUMsc0JBQXNCLENBQUMsbURBQW1ELENBQUMsQ0FBQztJQUNsRyxLQUFJLElBQUksQ0FBQyxHQUFDLENBQUMsRUFBRSxDQUFDLEdBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsRUFBRTtRQUMvQixJQUFJLEdBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQWlCLENBQUM7UUFDckMsT0FBTyxJQUFJLENBQUM7S0FDYjtJQUNELE9BQU8sSUFBSSxDQUFDO0FBQ2QsQ0FBQztBQUdELE1BQU0sVUFBVSxjQUFjLENBQUMsSUFBYztJQUUzQyxNQUFNLElBQUksR0FBRyxRQUFRLENBQUMsc0JBQXNCLENBQUMsK0JBQStCLENBQUMsQ0FBQztJQUU5RSxJQUFJLFFBQVEsR0FBd0IsSUFBSSxDQUFDO0lBQ3pDLElBQUksT0FBTyxHQUFHLElBQUksQ0FBQztJQUNuQixLQUFJLElBQUksQ0FBQyxHQUFDLENBQUMsRUFBRSxDQUFDLEdBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQUMsRUFBRTtRQUMvQixRQUFRLEdBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQWlCLENBQUMsYUFBYSxDQUFDO1FBQ3ZELElBQUcsUUFBUSxJQUFJLElBQUk7WUFDakIsT0FBTyxJQUFJLENBQUM7UUFFZCxJQUFHLENBQUEsUUFBUSxhQUFSLFFBQVEsdUJBQVIsUUFBUSxDQUFFLFlBQVksQ0FBQyxhQUFhLENB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QUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBRW5DLElBQUcsQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDO1lBQzdDLFNBQVMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQztLQUMzQztJQUVELE1BQU0sT0FBTyxHQUFHLFNBQVMsQ0FBQyxNQUFNLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzNELE1BQU0sT0FBTyxHQUFHLFNBQVMsQ0FBQyxNQUFNLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLFNBQVMsQ0FBQyxNQUFNLEdBQUMsQ0FBQyxDQUFDLENBQUM7SUFFNUUsWUFBWSxDQUFDLENBQUMsQ0FBQyxHQUFHLFNBQVMsQ0FBQyxNQUFNLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzdELFlBQVksQ0FBQyxDQUFDLENBQUMsR0FBRyxTQUFTLENBQUMsTUFBTSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsTUFBTSxHQUFFLENBQUMsQ0FBQyxDQUFDO0lBQy9FLFlBQVksQ0FBQyxDQUFDLENBQUMsR0FBRyxPQUFPLENBQUM7SUFDMUIsWUFBWSxDQUFDLENBQUMsQ0FBQyxHQUFHLE9BQU8sQ0FBQztBQUM1QixDQUFDO0FBRUQsTUFBTSxVQUFVLGdCQUFnQixDQUFDLElBQWE7SUFDNUMsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQztJQUM5QixNQUFNLGVBQWUsR0FBRyxNQUFNLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQztJQUM5QyxNQUFNLGFBQWEsR0FB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dXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIERHIGZyb20gJ2RhdGFncm9rLWFwaS9kZyc7XHJcbmltcG9ydCB7R3JpZENlbGxSZW5kZXJlckV4fSBmcm9tIFwiLi4vcmVuZGVyZXIvR3JpZENlbGxSZW5kZXJlckV4XCI7XHJcbmltcG9ydCAqIGFzIFRleHRVdGlscyBmcm9tIFwiLi9UZXh0VXRpbHNcIjtcclxuLypcclxuY29uc3QgY2FudmFzID0gdWkuY2FudmFzKDIwMCpyLCAzMDAqcik7XHJcblxyXG5jZWxsR3JpZC5yZW5kZXJlci5yZW5kZXIoMTAsIDEwLCAyMDAsIDMwMCk7XHJcblxyXG5jb25zdCByID0gd2luZG93LmRldmljZVBpeGVsUmF0aW87XHJcbnggPSByICogeDsgeSA9IHIgKiB5O1xyXG53ID0gciAqIHc7IGggPSByICogaDtcclxuKi9cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRHcmlkRGFydFBvcHVwTWVudSgpIDogSFRNTEVsZW1lbnQgfCBudWxsIHtcclxuXHJcbiAgbGV0IGVEaXYgPSBudWxsO1xyXG4gIGNvbnN0IGNEaXYgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCdkNC1tZW51LWl0ZW0tY29udGFpbmVyIGQ0LXZlcnQtbWVudSBkNC1tZW51LXBvcHVwJyk7XHJcbiAgZm9yKGxldCBuPTA7IG48Y0Rpdi5sZW5ndGg7ICsrbikge1xyXG4gICAgZURpdiA9IChjRGl2Lml0ZW0obikgYXMgSFRNTEVsZW1lbnQpO1xyXG4gICAgcmV0dXJuIGVEaXY7XHJcbiAgfVxyXG4gIHJldHVybiBudWxsO1xyXG59XHJcblxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGdldFRvb2xJY29uRGl2KGdyaWQgOiBERy5HcmlkKSA6IEhUTUxFbGVtZW50IHwgbnVsbCB7XHJcblxyXG4gIGNvbnN0IGNJbWcgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCdncm9rLWljb24gZ3Jvay1mb250LWljb24tbWVudScpO1xyXG5cclxuICBsZXQgZURpdkhhbWIgOiBIVE1MRWxlbWVudCB8IG51bGwgPSBudWxsO1xyXG4gIGxldCBlUGFyZW50ID0gbnVsbDtcclxuICBmb3IobGV0IG49MDsgbjxjSW1nLmxlbmd0aDsgKytuKSB7XHJcbiAgICBlRGl2SGFtYiA9IChjSW1nLml0ZW0obikgYXMgSFRNTEVsZW1lbnQpLnBhcmVudEVsZW1lbnQ7XHJcbiAgICBpZihlRGl2SGFtYiA9PSBudWxsKVxyXG4gICAgICByZXR1cm4gbnVsbDtcclxuXHJcbiAgICBpZihlRGl2SGFtYj8uZ2V0QXR0cmlidXRlKCdjb2x1bW5fbmFtZScpICE9PSBudWxsKXsvLydkYXRhJykgPT09ICdDb2xIYW1iJykge1xyXG4gICAgICBlUGFyZW50ID0gZURpdkhhbWIucGFyZW50RWxlbWVudDtcclxuICAgICAgd2hpbGUoZVBhcmVudCAhPT0gbnVsbCkge1xyXG4gICAgICAgIGlmKGVQYXJlbnQgPT09IGdyaWQucm9vdClcclxuICAgICAgICAgIHJldHVybiBlRGl2SGFtYjtcclxuXHJcbiAgICAgICAgZVBhcmVudCA9IGVQYXJlbnQucGFyZW50RWxlbWVudDtcclxuICAgICAgfVxyXG4gICAgIH1cclxuICB9XHJcbiAgcmV0dXJuIG51bGw7XHJcbn1cclxuXHJcblxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGlzSGl0VGVzdE9uRWxlbWVudChlRWxlbTogSFRNTEVsZW1lbnQsIGVNb3VzZSA6IE1vdXNlRXZlbnQpIDogYm9vbGVhbiB7XHJcbiAgY29uc3QgZUVsZW1IaXQgPSBkb2N1bWVudC5lbGVtZW50RnJvbVBvaW50KGVNb3VzZS5jbGllbnRYLCBlTW91c2UuY2xpZW50WSk7XHJcbiAgY29uc3QgYiA9IGVFbGVtSGl0ID09IGVFbGVtO1xyXG4gIHJldHVybiBiO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gaXNSb3dIZWFkZXIoY29sR3JpZCA6IERHLkdyaWRDb2x1bW4pIDogYm9vbGVhbiB7XHJcbiAgcmV0dXJuIGNvbEdyaWQuaWR4ID09PSAwIHx8IGNvbEdyaWQubmFtZSA9PT0gJ3JvdyBoZWFkZXInO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0SW5zdGFsbGVkR3JpZEZvckNvbHVtbihjb2xHcmlkIDogREcuR3JpZENvbHVtbikgOiBERy5HcmlkIHwgbnVsbCB7XHJcbiAgY29uc3QgZGFydCA6IGFueSA9IERHLnRvRGFydChjb2xHcmlkKTtcclxuICBpZighKGRhcnQubV9ncmlkIGluc3RhbmNlb2YgREcuR3JpZCkpXHJcbiAgICByZXR1cm4gbnVsbDtcclxuXHJcbiAgcmV0dXJuIGRhcnQubV9ncmlkO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gaW5zdGFsbEdyaWRGb3JDb2x1bW4oZ3JpZCA6IERHLkdyaWQsIGNvbEdyaWQgOiBERy5HcmlkQ29sdW1uKSA6IGJvb2xlYW4ge1xyXG4gIGlmKGNvbEdyaWQuZ3JpZCBpbnN0YW5jZW9mIERHLkdyaWQpXHJcbiAgICByZXR1cm4gZmFsc2U7XHJcblxyXG4gIGNvbnN0IGRhcnQgOiBhbnkgPSBERy50b0RhcnQoY29sR3JpZCk7XHJcbiAgaWYoZGFydC5tX2dyaWQgaW5zdGFuY2VvZiBERy5HcmlkKVxyXG4gICAgcmV0dXJuIGZhbHNlO1xyXG5cclxuICBkYXJ0Lm1fZ3JpZCA9IGdyaWQ7XHJcbiAgcmV0dXJuIHRydWU7XHJcbn1cclxuXHJcblxyXG5leHBvcnQgZnVuY3Rpb24gc2V0R3JpZENvbHVtblJlbmRlcmVyKGNvbEdyaWQgOiBERy5HcmlkQ29sdW1uLCByZW5kZXJlciA6IEdyaWRDZWxsUmVuZGVyZXJFeCkgOiB2b2lkIHtcclxuICBjb25zdCBkYXJ0IDogYW55ID0gREcudG9EYXJ0KGNvbEdyaWQpO1xyXG4gIGRhcnQubV9yZW5kZXJlciA9IHJlbmRlcmVyO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0R3JpZENvbHVtblJlbmRlcmVyKGNvbEdyaWQgOiBERy5HcmlkQ29sdW1uKSA6IEdyaWRDZWxsUmVuZGVyZXJFeCB8IG51bGwge1xyXG4gIGNvbnN0IGRhcnQgOiBhbnkgPSBERy50b0RhcnQoY29sR3JpZCk7XHJcbiAgY29uc3QgcmVuZGVyZXIgPSBkYXJ0Lm1fcmVuZGVyZXI7XHJcbiAgaWYocmVuZGVyZXIgPT09IHVuZGVmaW5lZClcclxuICAgIHJldHVybiBudWxsO1xyXG5cclxuICByZXR1cm4gcmVuZGVyZXI7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRHcmlkQ29sdW1uSGVhZGVySGVpZ2h0KGdyaWQgOiBERy5HcmlkKSA6IG51bWJlciB7XHJcbiAgY29uc3Qgb3B0aW9ucyA6IGFueSA9IGdyaWQuZ2V0T3B0aW9ucyh0cnVlKTtcclxuICBsZXQgbkhDb2xIZWFkZXIgPSBvcHRpb25zLmxvb2suY29sSGVhZGVySGVpZ2h0O1xyXG4gIGlmKG5IQ29sSGVhZGVyID09PSBudWxsIHx8IG5IQ29sSGVhZGVyID09PSB1bmRlZmluZWQpIHsvL0RHIGJ1Z1xyXG5cclxuICAgIGNvbnN0IGNlbGxHcmlkID0gZ3JpZC5oaXRUZXN0KDIsMik7Ly8uY2VsbChjb2wubmFtZSwgMCk7XHJcbiAgICBpZihjZWxsR3JpZCAhPT0gbnVsbCkge1xyXG4gICAgICBjb25zdCByYyA9IGNlbGxHcmlkLmJvdW5kcztcclxuICAgICAgcmV0dXJuIHJjLnk7XHJcbiAgICAgIC8vY29uc29sZS5sb2coJ3JjLnkgJyArIHJjLnkgKyBcIiByYy5oPSBcIiArIHJjLmhlaWdodCArIFwiIHJvdyBcIiArIGNlbGxHcmlkLmdyaWRSb3cgKyBcIiBuYW1lIFwiICsgIGNlbGxHcmlkLmdyaWRDb2x1bW4ubmFtZSk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIHJldHVybiBuSENvbEhlYWRlcjtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGdldEdyaWRSb3dIZWlnaHQoZ3JpZCA6IERHLkdyaWQpIDogbnVtYmVyIHtcclxuICBjb25zdCBvcHRpb25zIDogYW55ID0gZ3JpZC5nZXRPcHRpb25zKHRydWUpO1xyXG4gIGNvbnN0IG5IUm93ID0gIG9wdGlvbnMubG9vay5yb3dIZWlnaHQ7XHJcbiAgaWYobkhSb3cgPT09IG51bGwgfHwgbkhSb3cgPT09IHVuZGVmaW5lZCkgey8vREcgYnVnXHJcbiAgICBsZXQgY29sID0gbnVsbDtcclxuICAgIGNvbnN0IG5Db2xDb3VudCA9IGdyaWQuY29sdW1ucy5sZW5ndGg7XHJcbiAgICBmb3IobGV0IG5Db2w9MDsgbkNvbDxuQ29sQ291bnQ7ICsrbkNvbCkge1xyXG4gICAgICBjb2wgPSBncmlkLmNvbHVtbnMuYnlJbmRleChuQ29sKTtcclxuICAgICAgaWYoY29sID09PSBudWxsIHx8ICFjb2wudmlzaWJsZSlcclxuICAgICAgICBjb250aW51ZTtcclxuXHJcbiAgICAgIGNvbnN0IGNlbGxHcmlkID0gZ3JpZC5jZWxsKGNvbC5uYW1lLCAwKTtcclxuICAgICAgY29uc3QgcmMgPSBjZWxsR3JpZC5ib3VuZHM7XHJcbiAgICAgIHJldHVybiByYy5oZWlnaHQ7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gLTE7XHJcbiAgfVxyXG5cclxuICByZXR1cm4gbkhSb3c7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRHcmlkVmlzaWJsZVJvd0NvdW50KGdyaWQgOiBERy5HcmlkKSA6IG51bWJlciB7XHJcbiAgY29uc3QgZGZyYW1lID0gZ3JpZC5kYXRhRnJhbWU7XHJcbiAgY29uc3QgYml0c2V0RmlsdGVyID0gZGZyYW1lLmZpbHRlcjtcclxuICBjb25zdCBuUm93Q291bnQgPSBiaXRzZXRGaWx0ZXIudHJ1ZUNvdW50O1xyXG4gIHJldHVybiBuUm93Q291bnQ7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBmaWxsVmlzaWJsZVZpZXdwb3J0Um93cyhhck1pbk1heFJvd0lkeHMgOiBBcnJheTxudW1iZXI+LCBncmlkIDogREcuR3JpZCkgOiB2b2lkIHtcclxuICBpZihhck1pbk1heFJvd0lkeHMubGVuZ3RoICE9PSAyKVxyXG4gICAgdGhyb3cgbmV3IEVycm9yKFwiQXJyYXkgdG8gY29idGFpbiBpbmRpY2VzIG11c3QgaGF2ZSB0aGUgbGVuZ3RoIDIuXCIpO1xyXG5cclxuICBjb25zdCBzY3JvbGwgPSBncmlkLnZlcnRTY3JvbGw7XHJcbiAgY29uc3QgblJvd01pbiA9IE1hdGguZmxvb3Ioc2Nyb2xsLm1pbik7XHJcbiAgbGV0IG5Sb3dNYXggPSBNYXRoLmNlaWwoc2Nyb2xsLm1heCk7XHJcbiAgY29uc3QgblJvd0NvdW50ID0gZ2V0R3JpZFZpc2libGVSb3dDb3VudChncmlkKTtcclxuICBpZihuUm93TWF4ID49IG5Sb3dDb3VudCkge1xyXG4gICAgblJvd01heCA9IG5Sb3dDb3VudCAtMTtcclxuICB9XHJcblxyXG4gIGFyTWluTWF4Um93SWR4c1swXSA9IG5Sb3dNaW47XHJcbiAgYXJNaW5NYXhSb3dJZHhzWzFdID0gblJvd01heDtcclxuICAvL2NvbnNvbGUubG9nKCdtaW46ICcgKyBzY3JvbGwubWluICsgXCIgbWF4OiBcIiArIHNjcm9sbC5tYXggKyAnIG5Sb3dNYXggJyArIG5Sb3dNYXggKyBcIiBuVmlzUm93Q291bnQ6IFwiICsgblJvd0NvdW50KTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGZpbGxWaXNpYmxlVmlld3BvcnRHcmlkQ2VsbHMoYXJDb2xSb3dJZHhzIDogQXJyYXk8bnVtYmVyPiwgZ3JpZCA6IERHLkdyaWQpXHJcbntcclxuICBpZihhckNvbFJvd0lkeHMubGVuZ3RoICE9PSA0KVxyXG4gICAgdGhyb3cgbmV3IEVycm9yKFwiQXJyYXkgdG8gY29idGFpbiBib3VuZCByb3cgY29sdW1uIGluZGljZXMgbXVzdCBoYXZlIHRoZSBsZW5ndGggNC5cIik7XHJcblxyXG4gIGNvbnN0IGFyUm93SWR4cyA6IEFycmF5PG51bWJlcj4gPSBbXTtcclxuICBjb25zdCBhckNvbElkeHMgOiBBcnJheTxudW1iZXI+ID0gW107XHJcbiAgY29uc3QgbHN0VmlzaWJsZUNlbGxzID0gZ3JpZC5nZXRWaXNpYmxlQ2VsbHMoKTtcclxuICBmb3IobGV0IGNlbGxHVG1wIG9mIGxzdFZpc2libGVDZWxscylcclxuICB7XHJcbiAgICBpZighYXJSb3dJZHhzLmluY2x1ZGVzKGNlbGxHVG1wLmdyaWRSb3cpKVxyXG4gICAgICBhclJvd0lkeHMucHVzaChjZWxsR1RtcC5ncmlkUm93KTtcclxuXHJcbiAgICBpZighYXJDb2xJZHhzLmluY2x1ZGVzKGNlbGxHVG1wLmdyaWRDb2x1bW4uaWR4KSlcclxuICAgICAgYXJDb2xJZHhzLnB1c2goY2VsbEdUbXAuZ3JpZENvbHVtbi5pZHgpO1xyXG4gIH1cclxuXHJcbiAgY29uc3QgblJvd01pbiA9IGFyUm93SWR4cy5sZW5ndGggPT09IDAgPyAtMSA6IGFyUm93SWR4c1swXTtcclxuICBjb25zdCBuUm93TWF4ID0gYXJSb3dJZHhzLmxlbmd0aCA9PT0gMCA/IC0yIDogYXJSb3dJZHhzW2FyUm93SWR4cy5sZW5ndGgtMV07XHJcblxyXG4gIGFyQ29sUm93SWR4c1swXSA9IGFyQ29sSWR4cy5sZW5ndGggPT09IDAgPyAtMSA6IGFyQ29sSWR4c1swXTtcclxuICBhckNvbFJvd0lkeHNbMV0gPSBhckNvbElkeHMubGVuZ3RoID09PSAwID8gLTIgOiBhckNvbElkeHNbYXJDb2xJZHhzLmxlbmd0aCAtMV07XHJcbiAgYXJDb2xSb3dJZHhzWzJdID0gblJvd01pbjtcclxuICBhckNvbFJvd0lkeHNbM10gPSBuUm93TWF4O1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0QWN0aXZlR3JpZFJvdyhncmlkOiBERy5HcmlkKSB7XHJcbiAgY29uc3QgZGZyYW1lID0gZ3JpZC5kYXRhRnJhbWU7XHJcbiAgY29uc3QgblJvd1RhYmxlQWN0aXZlID0gZGZyYW1lLmN1cnJlbnRSb3cuaWR4O1xyXG4gIGNvbnN0IG5HcmlkQ29sQ291bnQgPSBncmlkLmNvbHVtbnMubGVuZ3RoO1xyXG4gIGxldCBjb2xHcmlkID0gbnVsbDtcclxuICBsZXQgY2VsbEdyaWQgPSBudWxsO1xyXG4gIGZvcihsZXQgbkNvbD0wOyBuQ29sPG5HcmlkQ29sQ291bnQ7ICsrbkNvbCkge1xyXG4gICAgY29sR3JpZCA9IGdyaWQuY29sdW1ucy5ieUluZGV4KG5Db2wpO1xyXG4gICAgaWYoY29sR3JpZD8udmlzaWJsZSkge1xyXG5cclxuICAgICAgY29uc3QgbkdyaWRSb3dDb3VudCA9IGRmcmFtZS5maWx0ZXIudHJ1ZUNvdW50O1xyXG4gICAgICBmb3IobGV0IG5SPTA7IG5SPG5HcmlkUm93Q291bnQ7ICsrblIpIHtcclxuICAgICAgICBjZWxsR3JpZCA9IGdyaWQuY2VsbChjb2xHcmlkLm5hbWUsIG5SKTtcclxuICAgICAgICBpZihjZWxsR3JpZC50YWJsZVJvd0luZGV4ID09PSBudWxsIHx8IG5Sb3dUYWJsZUFjdGl2ZSA9PT0gbnVsbClcclxuICAgICAgICAgIGNvbnRpbnVlO1xyXG5cclxuICAgICAgICBpZihjZWxsR3JpZC50YWJsZVJvd0luZGV4ID09PSBuUm93VGFibGVBY3RpdmUpXHJcbiAgICAgICAgICByZXR1cm4gblI7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIC0xO1xyXG4gICAgfVxyXG4gIH1cclxuICByZXR1cm4gLTE7XHJcbn1cclxuXHJcblxyXG5jb25zdCBtX21hcFNjYWxlZEZvbnRzID0gbmV3IE1hcCgpO1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHNjYWxlRm9udChmb250IDogc3RyaW5nLCBmRmFjdG9yIDogbnVtYmVyKSA6IHN0cmluZyB7XHJcbiAgaWYoZkZhY3RvciA9PT0gMS4wKSB7XHJcbiAgICByZXR1cm4gZm9udDtcclxuICB9XHJcblxyXG4gIGNvbnN0IHN0cktleSA9IGZvbnQgKyBmRmFjdG9yLnRvU3RyaW5nKCk7XHJcbiAgbGV0IGZvbnRTY2FsZWQgPSBtX21hcFNjYWxlZEZvbnRzLmdldChzdHJLZXkpO1xyXG4gIGlmKGZvbnRTY2FsZWQgIT09IHVuZGVmaW5lZClcclxuICAgIHJldHVybiBmb250U2NhbGVkO1xyXG5cclxuICBjb25zdCBuRm9udFNpemUgOiBudW1iZXIgPSBUZXh0VXRpbHMuZ2V0Rm9udFNpemUoZm9udCk7XHJcbiAgZm9udFNjYWxlZCA9IFRleHRVdGlscy5zZXRGb250U2l6ZShmb250LCBNYXRoLmNlaWwobkZvbnRTaXplICogZkZhY3RvcikpO1xyXG4gIG1fbWFwU2NhbGVkRm9udHMuc2V0KHN0cktleSwgZm9udFNjYWxlZCk7XHJcblxyXG4gIHJldHVybiBmb250U2NhbGVkO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gcGFpbnRDb2xIZWFkZXJDZWxsKGcgOiBDYW52YXNSZW5kZXJpbmdDb250ZXh0MkQgfCBudWxsLCBuWCA6IG51bWJlciwgblkgOiBudW1iZXIsIG5XOiBudW1iZXIsIG5IOiBudW1iZXIsIGNvbEdyaWQgOiBERy5HcmlkQ29sdW1uKSB7XHJcblxyXG4gIGlmKGcgPT09IG51bGwpXHJcbiAgICByZXR1cm47XHJcblxyXG4gIGcuZmlsbFN0eWxlID0gXCJ3aGl0ZVwiO1xyXG4gIGcuZmlsbFJlY3Qoblgqd2luZG93LmRldmljZVBpeGVsUmF0aW8sIG5ZKndpbmRvdy5kZXZpY2VQaXhlbFJhdGlvLCBuVyp3aW5kb3cuZGV2aWNlUGl4ZWxSYXRpbywgbkgqd2luZG93LmRldmljZVBpeGVsUmF0aW8pO1xyXG5cclxuICBjb25zdCBncmlkID0gY29sR3JpZC5ncmlkO1xyXG4gIGNvbnN0IG9wdGlvbnMgOiBhbnkgPSBncmlkLmdldE9wdGlvbnModHJ1ZSk7XHJcblxyXG4gIGNvbnN0IGZvbnQgPSBvcHRpb25zLmxvb2suY29sSGVhZGVyRm9udCA9PSBudWxsIHx8IG9wdGlvbnMubG9vay5jb2xIZWFkZXJGb250ID09PSB1bmRlZmluZWQgPyBcImJvbGQgMTRweCBWb2x0YSBUZXh0LCBBcmlhbFwiIDogb3B0aW9ucy5sb29rLmNvbEhlYWRlckZvbnQ7XHJcbiAgY29uc3QgZm9udE5ldyA9IHNjYWxlRm9udChmb250LCB3aW5kb3cuZGV2aWNlUGl4ZWxSYXRpbyk7XHJcbiAgZy5mb250ID0gZm9udE5ldztcclxuXHJcbiAgbGV0IHN0ciA9IFRleHRVdGlscy50cmltVGV4dChjb2xHcmlkLm5hbWUsIGcsIG5XKTtcclxuXHJcbiAgY29uc3QgdG0gPSBnLm1lYXN1cmVUZXh0KHN0cik7XHJcbiAgY29uc3QgbldMYWJlbCA9IHRtLndpZHRoO1xyXG5cclxuICBjb25zdCBuQXNjZW50ID0gTWF0aC5hYnModG0uYWN0dWFsQm91bmRpbmdCb3hBc2NlbnQpO1xyXG4gIGNvbnN0IG5EZXNjZW50ID0gdG0uYWN0dWFsQm91bmRpbmdCb3hEZXNjZW50O1xyXG4gIGNvbnN0IG5IRm9udCA9ICBuQXNjZW50ICsgbkRlc2NlbnQ7Ly8gKyAyKm5ZSW5zZXQ7XHJcblxyXG4gIGNvbnN0IG5ISCA9IG5IKndpbmRvdy5kZXZpY2VQaXhlbFJhdGlvO1xyXG5cclxuICBnLnRleHRBbGlnbiA9ICdzdGFydCc7XHJcbiAgZy5maWxsU3R5bGUgPSBcIkJsYWNrXCI7XHJcbiAgY29uc3QgblhYID0gblgqd2luZG93LmRldmljZVBpeGVsUmF0aW8gKyBNYXRoLmNlaWwoMyp3aW5kb3cuZGV2aWNlUGl4ZWxSYXRpbyk7Ly8oKG5XKndpbmRvdy5kZXZpY2VQaXhlbFJhdGlvIC0gbldMYWJlbCkgPj4gMSk7XHJcbiAgY29uc3QgbllZID0gKG5ZKndpbmRvdy5kZXZpY2VQaXhlbFJhdGlvICsgbkhIIC0gTWF0aC5jZWlsKDMqd2luZG93LmRldmljZVBpeGVsUmF0aW8pKTsvLy0yKndpbmRvdy5kZXZpY2VQaXhlbFJhdGlvKTtcclxuICBnLmZpbGxUZXh0KHN0ciwgblhYLCBuWVkpO1xyXG59XHJcblxyXG5cclxuIl19