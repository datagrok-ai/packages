#!/bin/bash

log() {
  GREEN='\e[0;32m'
  NO_COLOR='\e[0m'
  echo -e $GREEN $1 $NO_COLOR
}

unlink_cleanup() {
  npm uninstall --location=global datagrok-api @datagrok-libraries/utils @datagrok-libraries/ml @datagrok-libraries/bio

  for dir in ${dirs[@]}; do
    echo "Removing node_modules and dist in $(pwd)"
    cd $package_dir && cd $dir
    rm -rf node_modules dist
  done
}

package_dir=$(pwd)

dirs=(
  "../../js-api/"
  "../../libraries/utils/"
  "../../libraries/ml/"
  "../../libraries/bio/"
)

unlink_cleanup

for dir in ${dirs[@]}; do
  cd $package_dir && cd $dir
  if [ $dir == "../../js-api/" ]; then
   git clean -f -X -d ./src
  fi
  log "npm install in $(pwd)"
  npm install
  log "npm link in $(pwd)"
  npm link
done

for dir in ${dirs[@]}; do
  cd $package_dir && cd $dir
  if [ $dir != "../../js-api/" ]; then
    log "npm link-all in $(pwd)"
    npm run link-all
  fi
  log "npm run build in $(pwd)"
  npm run build || exit
done

cd $package_dir
npm run link-all
